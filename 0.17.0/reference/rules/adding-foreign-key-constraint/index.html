<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://pg-language-server.com/0.17.0/reference/rules/adding-foreign-key-constraint/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>addingForeignKeyConstraint - Postgres Language Server</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../css/version-select.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "addingForeignKeyConstraint";
        var mkdocs_page_input_path = "reference/rules/adding-foreign-key-constraint.md";
        var mkdocs_page_url = "/0.17.0/reference/rules/adding-foreign-key-constraint/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Postgres Language Server
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../getting_started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../manual_installation/">Manual Installation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../configuration/">Configuration</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/syntax_diagnostics/">Syntax Diagnostics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/linting/">Linting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/type_checking/">Type Checking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/plpgsql/">PL/pgSQL Support</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../features/editor_features/">Autocompletion & Hover</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../guides/ide_setup/">Use in your IDE</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../guides/checking_migrations/">Checking Migrations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../guides/configure_database/">Configure database connection</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../guides/suppressions/">Suppressions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../guides/vcs_integration/">Integrate with VCS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../guides/continuous_integration/">Continuous Integration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../cli/">CLI Commands</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../">Linter Rules</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../rule_sources/">Rule Sources</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../env_variables/">Environment Variables</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Postgres Language Server</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">addingForeignKeyConstraint</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/supabase-community/postgres-language-server/edit/master/docs/reference/rules/adding-foreign-key-constraint.md">Edit on supabase-community/postgres-language-server</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="addingforeignkeyconstraint">addingForeignKeyConstraint</h1>
<p><strong>Diagnostic Category: <code>lint/safety/addingForeignKeyConstraint</code></strong></p>
<p><strong>Since</strong>: <code>vnext</code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This rule is recommended. A diagnostic error will appear when linting your code.</p>
</div>
<p><strong>Sources</strong>: 
- Inspired from: <a href="https://squawkhq.com/docs/adding-foreign-key-constraint" target="_blank"><code>squawk/adding-foreign-key-constraint</code></a></p>
<h2 id="description">Description</h2>
<p>Adding a foreign key constraint requires a table scan and a SHARE ROW EXCLUSIVE lock on both tables, which blocks writes.</p>
<p>Adding a foreign key constraint to an existing table can cause downtime by locking both tables while
verifying the constraint. PostgreSQL needs to check that all existing values in the referencing
column exist in the referenced table.</p>
<p>Instead, add the constraint as NOT VALID in one transaction, then VALIDATE it in another transaction.
This approach only takes a SHARE UPDATE EXCLUSIVE lock when validating, allowing concurrent writes.</p>
<h2 id="examples">Examples</h2>
<h3 id="invalid">Invalid</h3>
<pre><code class="language-sql">ALTER TABLE &quot;email&quot; ADD CONSTRAINT &quot;fk_user&quot; FOREIGN KEY (&quot;user_id&quot;) REFERENCES &quot;user&quot; (&quot;id&quot;);
</code></pre>
<pre><code class="language-sh">code-block.sql:1:1 lint/safety/addingForeignKeyConstraint ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ! Adding a foreign key constraint requires a table scan and locks on both tables.

  &gt; 1 │ ALTER TABLE &quot;email&quot; ADD CONSTRAINT &quot;fk_user&quot; FOREIGN KEY (&quot;user_id&quot;) REFERENCES &quot;user&quot; (&quot;id&quot;);
      │ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    2 │ 

  i This will block writes to both the referencing and referenced tables while PostgreSQL verifies the constraint.

  i Add the constraint as NOT VALID first, then VALIDATE it in a separate transaction.


</code></pre>
<pre><code class="language-sql">ALTER TABLE &quot;emails&quot; ADD COLUMN &quot;user_id&quot; INT REFERENCES &quot;user&quot; (&quot;id&quot;);
</code></pre>
<pre><code class="language-sh">code-block.sql:1:1 lint/safety/addingForeignKeyConstraint ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  ! Adding a column with a foreign key constraint requires a table scan and locks.

  &gt; 1 │ ALTER TABLE &quot;emails&quot; ADD COLUMN &quot;user_id&quot; INT REFERENCES &quot;user&quot; (&quot;id&quot;);
      │ ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    2 │ 

  i Using REFERENCES when adding a column will block writes while verifying the constraint.

  i Add the column without the constraint first, then add the constraint as NOT VALID and VALIDATE it separately.


</code></pre>
<h3 id="valid">Valid</h3>
<pre><code class="language-sql">-- First add the constraint as NOT VALID
ALTER TABLE &quot;email&quot; ADD CONSTRAINT &quot;fk_user&quot; FOREIGN KEY (&quot;user_id&quot;) REFERENCES &quot;user&quot; (&quot;id&quot;) NOT VALID;
-- Then validate it in a separate transaction
ALTER TABLE &quot;email&quot; VALIDATE CONSTRAINT &quot;fk_user&quot;;
</code></pre>
<h2 id="how-to-configure">How to configure</h2>
<pre><code class="language-json">
{
  &quot;linter&quot;: {
    &quot;rules&quot;: {
      &quot;safety&quot;: {
        &quot;addingForeignKeyConstraint&quot;: &quot;error&quot;
      }
    }
  }
}

</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/supabase-community/postgres-language-server" class="fa fa-code-fork" style="color: #fcfcfc"> supabase-community/postgres-language-server</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../js/version-select.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
