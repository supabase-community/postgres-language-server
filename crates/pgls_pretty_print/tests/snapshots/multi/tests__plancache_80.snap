---
source: crates/pgls_pretty_print/tests/tests.rs
input_file: crates/pgls_pretty_print/tests/data/multi/plancache.sql
---
create temporary table pcachetest as select * from int8_tbl;

prepare prepstmt as select * from pcachetest;;

execute prepstmt;

prepare prepstmt2 (bigint) as select * from pcachetest where q1 = $1;;

execute prepstmt2 (123);

drop table pcachetest;

execute prepstmt;

execute prepstmt2 (123);

create temporary table pcachetest as select * from int8_tbl order by 2;

execute prepstmt;

execute prepstmt2 (123);

alter table pcachetest
  add column q3 bigint;

execute prepstmt;

execute prepstmt2 (123);

alter table pcachetest
  drop column q3;

execute prepstmt;

execute prepstmt2 (123);

create temporary view pcacheview
as select * from pcachetest;

prepare vprep as select * from pcacheview;;

execute vprep;

create or replace temporary view pcacheview
as select q1, q2 / 2 as q2 from pcachetest;

execute vprep;

create function cache_test(int)
returns int
language plpgsql
as $function$
declare total int;
begin
	create temp table t1(f1 int);
	insert into t1 values($1);
	insert into t1 values(11);
	insert into t1 values(12);
	insert into t1 values(13);
	select sum(f1) into total from t1;
	drop table t1;
	return total;
end
$function$;

select cache_test(1);

select cache_test(2);

select cache_test(3);

create temporary view v1
as select 2 + 2 as f1;

create function cache_test_2()
returns int
language plpgsql
as $function$
begin
	return f1 from v1;
end
$function$;

select cache_test_2();

create or replace temporary view v1
as select 2 + 2 + 4 as f1;

select cache_test_2();

create or replace temporary view v1
as select
  2 + 2 + 4 +
  (select MAX(unique1) from tenk1)
  as f1;

select cache_test_2();

create schema "s1";

create table abc (f1 int);

create schema "s2";

create table abc (f1 int);

insert into s1.abc values (123);

insert into s2.abc values (456);

set search_path to s1;

prepare p1 as select f1 from abc;;

execute p1;

set search_path to s2;

select f1 from abc;

execute p1;

alter table s1.abc
  add column f2 double precision;

execute p1;

drop schema s1 cascade;

drop schema s2 cascade;

reset search_path;

create temporary sequence seq;

prepare p2 as select nextval('seq');;

execute p2;

drop sequence seq;

create temporary sequence seq;

execute p2;

create function cachebug()
returns void
language plpgsql
as $function$
declare r int;
begin
  drop table if exists temptable cascade;
  create temp table temptable as select * from generate_series(1,3) as f1;
  create temp view vv as select * from temptable;
  for r in select * from vv loop
    raise notice '%', r;
  end loop;
end
$function$;

select cachebug();

select cachebug();

create table pc_list_parted (a int)
partition by LIST(a);

create table pc_list_part_null partition of pc_list_parted for values in (null);

create table pc_list_part_1 partition of pc_list_parted for values in (1);

create table pc_list_part_def partition of pc_list_parted default;

insert into pc_list_part_def values ($1);

execute pstmt_def_insert (null);

execute pstmt_def_insert (1);

create table pc_list_part_2 partition of pc_list_parted for values in (2);

execute pstmt_def_insert (2);

alter table pc_list_parted
  detach partition
  pc_list_part_null;

execute pstmt_def_insert (null);

drop table pc_list_part_1;

execute pstmt_def_insert (1);

drop table pc_list_parted, pc_list_part_null;

deallocate pstmt_def_insert;

create table test_mode (a int);

insert into test_mode select 1 from generate_series(1, 1000) union all select 2;

create index on test_mode using btree (a);

analyze test_mode;

prepare test_mode_pp (int) as select COUNT(*) from test_mode where a = $1;;

select
  name,
  generic_plans,
  custom_plans
from
  pg_prepared_statements
where
  name = 'test_mode_pp';

set plan_cache_mode = auto;

explain (COSTS 'off') execute test_mode_pp (2);

select
  name,
  generic_plans,
  custom_plans
from
  pg_prepared_statements
where
  name = 'test_mode_pp';

set plan_cache_mode = force_generic_plan;

explain (COSTS 'off') execute test_mode_pp (2);

select
  name,
  generic_plans,
  custom_plans
from
  pg_prepared_statements
where
  name = 'test_mode_pp';

set plan_cache_mode = auto;

execute test_mode_pp (1);

execute test_mode_pp (1);

execute test_mode_pp (1);

execute test_mode_pp (1);

select
  name,
  generic_plans,
  custom_plans
from
  pg_prepared_statements
where
  name = 'test_mode_pp';

execute test_mode_pp (1);

select
  name,
  generic_plans,
  custom_plans
from
  pg_prepared_statements
where
  name = 'test_mode_pp';

explain (COSTS 'off') execute test_mode_pp (2);

set plan_cache_mode = force_custom_plan;

explain (COSTS 'off') execute test_mode_pp (2);

select
  name,
  generic_plans,
  custom_plans
from
  pg_prepared_statements
where
  name = 'test_mode_pp';

drop table test_mode;
