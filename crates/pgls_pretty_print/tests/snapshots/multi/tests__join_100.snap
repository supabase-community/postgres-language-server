---
source: crates/pgls_pretty_print/tests/tests.rs
input_file: crates/pgls_pretty_print/tests/data/multi/join.sql
snapshot_kind: text
---
create table j1_tbl (
  i INT,
  j INT,
  t TEXT
);

create table j2_tbl (
  i INT,
  k INT
);

insert into j1_tbl values (1, 4, 'one');

insert into j1_tbl values (2, 3, 'two');

insert into j1_tbl values (3, 2, 'three');

insert into j1_tbl values (4, 1, 'four');

insert into j1_tbl values (5, 0, 'five');

insert into j1_tbl values (6, 6, 'six');

insert into j1_tbl values (7, 7, 'seven');

insert into j1_tbl values (8, 8, 'eight');

insert into j1_tbl values (0, null, 'zero');

insert into j1_tbl values (null, null, 'null');

insert into j1_tbl values (null, 0, 'zero');

insert into j2_tbl values (1, -1);

insert into j2_tbl values (2, 2);

insert into j2_tbl values (3, -3);

insert into j2_tbl values (2, 4);

insert into j2_tbl values (5, -5);

insert into j2_tbl values (5, -5);

insert into j2_tbl values (0, null);

insert into j2_tbl values (null, null);

insert into j2_tbl values (null, 0);

create temporary table onerow ();

insert into onerow default values;

analyze onerow;

select * from j1_tbl as tx;

select * from j1_tbl as tx;

select * from j1_tbl as t1 (a, b, c);

select * from j1_tbl as t1 (a, b, c);

select * from j1_tbl as t1 (a, b, c), j2_tbl as t2 (d, e);

select t1.a, t2.e from j1_tbl as t1 (a, b, c), j2_tbl as t2 (d, e) where t1.a = t2.d;

select * from j1_tbl inner join j2_tbl on true;

select i, k, t from j1_tbl inner join j2_tbl on true;

select t1.i, k, t from j1_tbl as t1 inner join j2_tbl as t2 on true;

select ii, tt, kk from (j1_tbl inner join j2_tbl on true) as "tx" ("ii", "jj", "tt", "ii2", "kk");

select
  tx.ii,
  tx.jj,
  tx.kk
from
  (j1_tbl as t1 (a, b, c)
  inner join
    j2_tbl as t2 (d, e)
  on true) as "tx" ("ii",
  "jj",
  "tt",
  "ii2",
  "kk");

select * from j1_tbl inner join j2_tbl as a on true inner join j2_tbl as b on true;

select * from j1_tbl inner join j2_tbl using ("i");

select * from j1_tbl inner join j2_tbl using ("i");

select * from j1_tbl as t1 (a, b, c) inner join j2_tbl as t2 (a, d) using ("a") order by a, d;

select * from j1_tbl as t1 (a, b, c) inner join j2_tbl as t2 (a, b) using ("b") order by b, t1.a;

select * from j1_tbl inner join j2_tbl using ("i") where j1_tbl.t = 'one';

select * from j1_tbl inner join j2_tbl using ("i") as "x" where j1_tbl.t = 'one';

select * from (j1_tbl inner join j2_tbl using ("i")) as "x" where j1_tbl.t = 'one';

select * from j1_tbl inner join j2_tbl using ("i") as "x" where x.i = 1;

select * from j1_tbl inner join j2_tbl using ("i") as "x" where x.t = 'one';

select * from (j1_tbl inner join j2_tbl using ("i") as "x") as "xx" where x.i = 1;

select * from j1_tbl as a1 inner join j2_tbl as a2 using ("i") as "a1";

select x.* from j1_tbl inner join j2_tbl using ("i") as "x" where j1_tbl.t = 'one';

select row(x.*) from j1_tbl inner join j2_tbl using ("i") as "x" where j1_tbl.t = 'one';

select row_to_json(x.*) from j1_tbl inner join j2_tbl using ("i") as "x" where j1_tbl.t = 'one';

select * from j1_tbl natural join j2_tbl;

select * from j1_tbl as t1 (a, b, c) natural join j2_tbl as t2 (a, d);

select * from j1_tbl as t1 (a, b, c) natural join j2_tbl as t2 (d, a);

select * from j1_tbl as t1 (a, b) natural join j2_tbl as t2 (a);

select * from j1_tbl inner join j2_tbl on j1_tbl.i = j2_tbl.i;

select * from j1_tbl inner join j2_tbl on j1_tbl.i = j2_tbl.k;

select * from j1_tbl inner join j2_tbl on j1_tbl.i <= j2_tbl.k;

select * from j1_tbl left outer join j2_tbl using ("i") order by i, k, t;

select * from j1_tbl left outer join j2_tbl using ("i") order by i, k, t;

select * from j1_tbl right outer join j2_tbl using ("i");

select * from j1_tbl right outer join j2_tbl using ("i");

select * from j1_tbl full outer join j2_tbl using ("i") order by i, k, t;

select * from j1_tbl full outer join j2_tbl using ("i") order by i, k, t;

select * from j1_tbl left outer join j2_tbl using ("i") where k = 1;

select * from j1_tbl left outer join j2_tbl using ("i") where i = 1;

select
  *
from
  tenk1 as a,
  tenk1 as b
where
  exists
  (
    select
      *
    from
      tenk1 as c
    where
      b.twothousand = c.twothousand and
      b.fivethous <> c.fivethous
  ) and
  a.tenthous = b.tenthous and
  a.tenthous < 5000;

create table t1 (
  name TEXT,
  n INT
);

create table t2 (
  name TEXT,
  n INT
);

create table t3 (
  name TEXT,
  n INT
);

insert into t1 values ('bb', 11);

insert into t2 values ('bb', 12);

insert into t2 values ('cc', 22);

insert into t2 values ('ee', 42);

insert into t3 values ('bb', 13);

insert into t3 values ('cc', 23);

insert into t3 values ('dd', 33);

select * from t1 full outer join t2 using ("name") full outer join t3 using ("name");

select * from (select * from t2) as s2 inner join (select * from t3) as s3 using ("name");

select * from (select * from t2) as s2 left outer join (select * from t3) as s3 using ("name");

select * from (select * from t2) as s2 full outer join (select * from t3) as s3 using ("name");

select
  *
from
  (select name, n as s2_n, 2 as s2_2 from t2) as s2
  natural join
    (select name, n as s3_n, 3 as s3_2 from t3) as s3;

select
  *
from
  (select name, n as s2_n, 2 as s2_2 from t2) as s2
  natural left join
    (select name, n as s3_n, 3 as s3_2 from t3) as s3;

select
  *
from
  (select name, n as s2_n, 2 as s2_2 from t2) as s2
  natural full join
    (select name, n as s3_n, 3 as s3_2 from t3) as s3;

select
  *
from
  (select name, n as s1_n, 1 as s1_1 from t1) as s1
  natural join
    (select name, n as s2_n, 2 as s2_2 from t2) as s2
  natural join
    (select name, n as s3_n, 3 as s3_2 from t3) as s3;

select
  *
from
  (select name, n as s1_n, 1 as s1_1 from t1) as s1
  natural full join
    (select name, n as s2_n, 2 as s2_2 from t2) as s2
  natural full join
    (select name, n as s3_n, 3 as s3_2 from t3) as s3;

select
  *
from
  (select name, n as s1_n from t1) as s1
  natural full join
    (
      select
        *
      from
        (select name, n as s2_n from t2) as s2
        natural full join
          (select name, n as s3_n from t3) as s3
    )
    as ss2;

select
  *
from
  (select name, n as s1_n from t1) as s1
  natural full join
    (
      select
        *
      from
        (select name, n as s2_n, 2 as s2_2 from t2) as s2
        natural full join
          (select name, n as s3_n from t3) as s3
    )
    as ss2;

select
  *
from
  (select name, n as s1_n from t1) as s1
  full outer join
    (select name, 2 as s2_n from t2) as s2
  on s1_n = s2_n;

create temporary table x (
  x1 INT,
  x2 INT
);

insert into x values (1, 11);

insert into x values (2, 22);

insert into x values (3, null);

insert into x values (4, 44);

insert into x values (5, null);

create temporary table y (
  y1 INT,
  y2 INT
);

insert into y values (1, 111);

insert into y values (2, 222);

insert into y values (3, 333);

insert into y values (4, null);

select * from x;

select * from y;

select * from x left outer join y on x1 = y1 and x2 is not null;

select * from x left outer join y on x1 = y1 and y2 is not null;

select * from x left outer join y on x1 = y1 left outer join x as xx (xx1, xx2) on x1 = xx1;

select
  *
from
  x left outer join y on x1 = y1
  left outer join
    x as xx (xx1, xx2)
  on x1 = xx1 and x2 is not null;

select
  *
from
  x left outer join y on x1 = y1
  left outer join
    x as xx (xx1, xx2)
  on x1 = xx1 and y2 is not null;

select
  *
from
  x left outer join y on x1 = y1
  left outer join
    x as xx (xx1, xx2)
  on x1 = xx1 and xx2 is not null;

select
  *
from
  x left outer join y on x1 = y1
  left outer join
    x as xx (xx1, xx2)
  on x1 = xx1
where
  x2 is not null;

select
  *
from
  x left outer join y on x1 = y1
  left outer join
    x as xx (xx1, xx2)
  on x1 = xx1
where
  y2 is not null;

select
  *
from
  x left outer join y on x1 = y1
  left outer join
    x as xx (xx1, xx2)
  on x1 = xx1
where
  xx2 is not null;

select
  COUNT(*)
from
  tenk1 as a
where
  unique1 in
  (
    select
      unique1
    from
      tenk1 as b inner join tenk1 as c using ("unique1")
    where
      b.unique2 = 42
  );

select
  COUNT(*)
from
  tenk1 as x
where
  x.unique1 in
  (
    select
      a.f1
    from
      int4_tbl as a,
      float8_tbl as b
    where
      a.f1 = b.f1
  ) and
  x.unique1 = 0 and
  x.unique1 in
  (
    select
      aa.f1
    from
      int4_tbl as aa,
      float8_tbl as bb
    where
      aa.f1 = bb.f1
  );

begin;

set geqo = 'on';

set geqo_threshold = 2;

select
  COUNT(*)
from
  tenk1 as x
where
  x.unique1 in
  (
    select
      a.f1
    from
      int4_tbl as a,
      float8_tbl as b
    where
      a.f1 = b.f1
  ) and
  x.unique1 = 0 and
  x.unique1 in
  (
    select
      aa.f1
    from
      int4_tbl as aa,
      float8_tbl as bb
    where
      aa.f1 = bb.f1
  );

rollback;

select
  aa,
  bb,
  unique1,
  unique1
from
  tenk1 right outer join b_star on aa = unique1
where
  bb < bb and bb is null;

select
  aa,
  bb,
  unique1,
  unique1
from
  tenk1 right outer join b_star on aa = unique1
where
  bb < bb and bb is null;

select
  *
from
  int8_tbl as i1
  left outer join
    int8_tbl as i2
    inner join
      (select 123 as x) as ss
    on i2.q1 = x
  on i1.q2 = i2.q2
order by 1,
  2;

select
  *
from
  int8_tbl as i1
  left outer join
    int8_tbl as i2
    inner join
      (select 123 as x) as ss
    on i2.q1 = x
  on i1.q2 = i2.q2
order by 1,
  2;

select
  COUNT(*)
from
  (
    select
      t3.tenthous as x1,
      coalesce(t1.stringu1, t2.stringu1) as x2
    from
      tenk1 as t1
      left outer join
        tenk1 as t2
      on t1.unique1 = t2.unique1
      inner join
        tenk1 as t3
      on t1.unique2 = t3.unique2
  )
  as ss,
  tenk1 as t4,
  tenk1 as t5
where
  t4.thousand = t5.unique1 and
  ss.x1 = t4.tenthous and
  ss.x2 = t5.stringu1;

select
  a.f1,
  b.f1,
  t.thousand,
  t.tenthous
from
  tenk1 as t,
  (
    select SUM(f1) + 1 as f1 from int4_tbl as i4a
  )
  as a,
  (select SUM(f1) as f1 from int4_tbl as i4b) as b
where
  b.f1 = t.thousand and
  a.f1 = b.f1 and
  a.f1 + b.f1 + 999 = t.tenthous;

select
  a.f1,
  b.f1,
  t.thousand,
  t.tenthous
from
  tenk1 as t,
  (
    select SUM(f1) + 1 as f1 from int4_tbl as i4a
  )
  as a,
  (select SUM(f1) as f1 from int4_tbl as i4b) as b
where
  b.f1 = t.thousand and
  a.f1 = b.f1 and
  a.f1 + b.f1 + 999 = t.tenthous;

select
  t1.unique1,
  t2.unique1
from
  tenk1 as t1
  inner join
    tenk1 as t2
  on t1.two = t2.two and
    t1.unique1 =
    (
      select
        MIN(unique1)
      from
        tenk1
      where
        t2.unique1 = unique1
    )
where
  t1.unique1 < 10 and t2.unique1 < 10
order by t1.unique1;

select
  t1.unique1,
  t2.unique1
from
  tenk1 as t1
  inner join
    tenk1 as t2
  on t1.two = t2.two and
    t1.unique1 =
    (
      select
        MIN(unique1)
      from
        tenk1
      where
        t2.unique1 = unique1
    )
where
  t1.unique1 < 10 and t2.unique1 < 10
order by t1.unique1;

select
  t1.f1
from
  int4_tbl as t1,
  int4_tbl as t2
  left outer join
    int4_tbl as t3
  on t3.f1 > 0
  left outer join
    int4_tbl as t4
  on t3.f1 > 1
where
  t4.f1 is null;

select
  t1.f1
from
  int4_tbl as t1,
  int4_tbl as t2
  left outer join
    int4_tbl as t3
  on t3.f1 > 0
  left outer join
    int4_tbl as t4
  on t3.f1 > 1
where
  t4.f1 is null;

select
  *
from
  int4_tbl as t1
  left outer join
    int4_tbl as t2
  on true
  left outer join
    int4_tbl as t3
  on t2.f1 > 0
  left outer join
    int4_tbl as t4
  on t3.f1 > 0;

select
  *
from
  onek as t1
  left outer join
    onek as t2
  on t1.unique1 = t2.unique1
  left outer join
    onek as t3
  on t2.unique1 <> t3.unique1
  left outer join
    onek as t4
  on t3.unique1 = t4.unique1;

select
  *
from
  int4_tbl as t1
  left outer join
    (
      select
        NOW()
      from
        int4_tbl as t2
        left outer join
          int4_tbl as t3
        on t2.f1 = t3.f1
        left outer join
          int4_tbl as t4
        on t3.f1 = t4.f1
    )
    as s
  on true
  inner join
    int4_tbl as t5
  on true;

select
  *
from
  int4_tbl as t1
  left outer join
    int4_tbl as t2
  on true
  left outer join
    int4_tbl as t3
  on true
  left outer join
    int4_tbl as t4
  on t2.f1 = t3.f1;

select
  *
from
  int4_tbl as t1
  left outer join
    int4_tbl as t2
  on true
  left outer join
    int4_tbl as t3
  on t2.f1 = t3.f1
  left outer join
    int4_tbl as t4
  on t3.f1 <> t4.f1;

select
  *
from
  int4_tbl as t1
  left outer join
    int4_tbl as t2
    left outer join
      int4_tbl as t3
    on t2.f1 > 0
  on t2.f1 > 1
  left outer join
    int4_tbl as t4
  on t2.f1 > 2 and t3.f1 > 3
where
  t1.f1 = coalesce(t2.f1, 1);

select
  *
from
  int4_tbl as t1
  left outer join
    (
      select
        t2.f1
      from
        int4_tbl as t2
        left outer join
          int4_tbl as t3
        on t2.f1 > 0
      where
        t3.f1 is null
    )
    as s
    left outer join
      tenk1 as t4
    on s.f1 > 1
  on s.f1 = t1.f1;

select
  *
from
  int4_tbl as t1
  left outer join
    (
      select
        t2.f1
      from
        int4_tbl as t2
        left outer join
          int4_tbl as t3
        on t2.f1 > 0
      where
        t2.f1 <> coalesce(t3.f1, -1)
    )
    as s
    left outer join
      tenk1 as t4
    on s.f1 > 1
  on s.f1 = t1.f1;

select
  *
from
  onek as t1
  left outer join
    onek as t2
  on t1.unique1 = t2.unique1
  left outer join
    onek as t3
  on t2.unique1 = t3.unique1
  left outer join
    onek as t4
  on t3.unique1 = t4.unique1 and
    t2.unique2 = t4.unique2;

select
  *
from
  int8_tbl as t1
  left outer join
    int8_tbl as t2
    left outer join
      int8_tbl as t3
      full outer join
        int8_tbl as t4
      on false
    on false
    left outer join
      int8_tbl as t5
    on t2.q1 = t5.q1
  on t2.q2 = 123;

select
  *
from
  int8_tbl as t1
  left outer join
    int8_tbl as t2
  on true
  left outer join
    lateral (
      select
        *
      from
        int8_tbl as t3
      where
        t3.q1 = t2.q1
      offset 0
    )
    as s
  on t2.q1 = 1;

select
  *
from
  int8_tbl as t1
  left outer join
    int8_tbl as t2
  on true
  left outer join
    lateral (
      select * from generate_series(t2.q1, 100)
    )
    as s
  on t2.q1 = 1;

select
  *
from
  int8_tbl as t1
  left outer join
    int8_tbl as t2
  on true
  left outer join
    lateral (select t2.q1 from int8_tbl as t3) as s
  on t2.q1 = 1;

select
  *
from
  onek as t1 left outer join onek as t2 on true
  left outer join
    lateral (
      select
        *
      from
        onek as t3
      where
        t3.two = t2.two
      offset 0
    )
    as s
  on t2.unique1 = 1;

select
  *
from
  j1_tbl
  full outer join
    (
      select
        *
      from
        j2_tbl
      order by j2_tbl.i desc,
        j2_tbl.k asc
    )
    as j2_tbl
  on j1_tbl.i = j2_tbl.i and j1_tbl.i = j2_tbl.k;

select
  *
from
  j1_tbl
  full outer join
    (
      select
        *
      from
        j2_tbl
      order by j2_tbl.i desc,
        j2_tbl.k asc
    )
    as j2_tbl
  on j1_tbl.i = j2_tbl.i and j1_tbl.i = j2_tbl.k;

select
  COUNT(*)
from
  (
    select
      *
    from
      tenk1 as x
    order by x.thousand,
      x.twothousand,
      x.fivethous
  )
  as x
  left outer join
    (select * from tenk1 as y order by y.unique2) as y
  on x.thousand = y.unique2 and
    x.twothousand = y.hundred and
    x.fivethous = y.unique2;

select
  COUNT(*)
from
  (
    select
      *
    from
      tenk1 as x
    order by x.thousand,
      x.twothousand,
      x.fivethous
  )
  as x
  left outer join
    (select * from tenk1 as y order by y.unique2) as y
  on x.thousand = y.unique2 and
    x.twothousand = y.hundred and
    x.fivethous = y.unique2;

set enable_hashjoin = 0;

set enable_nestloop = 0;

set enable_hashagg = 0;

select
  x.thousand,
  x.twothousand,
  COUNT(*)
from
  tenk1 as x
  inner join
    tenk1 as y
  on x.thousand = y.thousand
group by x.thousand,
  x.twothousand
order by x.thousand desc,
  x.twothousand;

reset enable_hashagg;

reset enable_nestloop;

reset enable_hashjoin;

drop TABLE t1;

drop TABLE t2;

drop TABLE t3;

drop TABLE j1_tbl;

drop TABLE j2_tbl;

create temporary table t1 (
  a INT,
  b INT
);

create temporary table t2 (
  a INT,
  b INT
);

create temporary table t3 (
  x INT,
  y INT
);

insert into t1 values (5, 10);

insert into t1 values (15, 20);

insert into t1 values (100, 100);

insert into t1 values (200, 1000);

insert into t2 values (200, 2000);

insert into t3 values (5, 20);

insert into t3 values (6, 7);

insert into t3 values (7, 8);

insert into t3 values (500, 100);

delete from t3 using t1 as table1 where t3.x = table1.a;

select * from t3;

delete from t3 using t1 inner join t2 using ("a") where t3.x > t1.a;

select * from t3;

delete from t3 using t3 as t3_other where t3.x = t3_other.x and t3.y = t3_other.y;

select * from t3;

create temporary table t2a ()
inherits (t2);

insert into t2a values (200, 2001);

select * from t1 left outer join t2 on t1.a = t2.a;

select t1.x from t1 inner join t3 on t1.a = t3.x;

select
  t1.*,
  t2.*,
  unnamed_join.*
from
  t1 inner join t2 on t1.a = t2.a,
  t3 as unnamed_join
for update of unnamed_join;

select
  foo.*,
  unnamed_join.*
from
  t1 inner join t2 using ("a") as "foo",
  t3 as unnamed_join
for update of unnamed_join;

select
  foo.*,
  unnamed_join.*
from
  t1 inner join t2 using ("a") as "foo",
  t3 as unnamed_join
for update of foo;

select
  bar.*,
  unnamed_join.*
from
  (t1 inner join t2 using ("a") as "foo") as "bar",
  t3 as unnamed_join
for update of foo;

select
  bar.*,
  unnamed_join.*
from
  (t1 inner join t2 using ("a") as "foo") as "bar",
  t3 as unnamed_join
for update of bar;

create temporary table tt1 (
  tt1_id INT,
  joincol INT
);

insert into tt1 values (1, 11);

insert into tt1 values (2, null);

create temporary table tt2 (
  tt2_id INT,
  joincol INT
);

insert into tt2 values (21, 11);

insert into tt2 values (22, 11);

set enable_hashjoin = off;

set enable_nestloop = off;

select tt1.*, tt2.* from tt1 left outer join tt2 on tt1.joincol = tt2.joincol;

select tt1.*, tt2.* from tt2 right outer join tt1 on tt1.joincol = tt2.joincol;

reset enable_hashjoin;

reset enable_nestloop;

create temporary table tbl_ra (
  a INT unique,
  b INT
);

insert into tbl_ra select i, i % 100 from generate_series(1, 1000) as i;

create index on tbl_ra using btree (b);

analyze tbl_ra;

set enable_hashjoin = off;

set enable_nestloop = off;

select
  *
from
  tbl_ra as t1
where
  not exists
  (
    select 1 from tbl_ra as t2 where t2.b = t1.a
  ) and
  t1.b < 2;

select
  *
from
  tbl_ra as t1
where
  not exists
  (
    select 1 from tbl_ra as t2 where t2.b = t1.a
  ) and
  t1.b < 2;

reset enable_hashjoin;

reset enable_nestloop;

create temporary table tbl_rs (
  a INT,
  b INT
);

insert into tbl_rs select i, i from generate_series(1, 10) as i;

analyze tbl_rs;

select
  *
from
  tbl_rs as t1
  inner join
    lateral (
      select
        *
      from
        tbl_rs as t2
      where
        t2.a in (select t1.a + t3.a from tbl_rs as t3) and
        t2.a < 5
    )
  on true;

select
  *
from
  tbl_rs as t1
  inner join
    lateral (
      select
        *
      from
        tbl_rs as t2
      where
        t2.a in (select t1.a + t3.a from tbl_rs as t3) and
        t2.a < 5
    )
  on true;

set work_mem = '64kB';

set enable_mergejoin = off;

set enable_memoize = off;

select COUNT(*) from tenk1 as a, tenk1 as b where a.hundred = b.thousand and b.fivethous % 10 < 10;

select COUNT(*) from tenk1 as a, tenk1 as b where a.hundred = b.thousand and b.fivethous % 10 < 10;

reset work_mem;

reset enable_mergejoin;

reset enable_memoize;

create temporary table tt3 (
  f1 INT,
  f2 TEXT
);

insert into tt3 select x, repeat('xyzzy', 100) from generate_series(1, 10000) as x;

analyze tt3;

create temporary table tt4 (f1 INT);

insert into tt4 values (0), (1), (9999);

analyze tt4;

set enable_nestloop = off;

select
  a.f1
from
  tt4 as a
  left outer join
    (
      select
        b.f1
      from
        tt3 as b left outer join tt3 as c on b.f1 = c.f1
      where
        coalesce(c.f1, 0) = 0
    )
    as d
  on a.f1 = d.f1
where
  coalesce(d.f1, 0) = 0
order by 1;

select
  a.f1
from
  tt4 as a
  left outer join
    (
      select
        b.f1
      from
        tt3 as b left outer join tt3 as c on b.f1 = c.f1
      where
        coalesce(c.f1, 0) = 0
    )
    as d
  on a.f1 = d.f1
where
  coalesce(d.f1, 0) = 0
order by 1;

reset enable_nestloop;

select a.* from tenk1 as a where unique1 in (select unique2 from tenk1 as b);

select a.* from tenk1 as a where not unique1 in (select unique2 from tenk1 as b);

select a.* from tenk1 as a where exists (select 1 from tenk1 as b where a.unique1 = b.unique2);

select a.* from tenk1 as a where not exists (select 1 from tenk1 as b where a.unique1 = b.unique2);

select
  a.*
from
  tenk1 as a
  left outer join
    tenk1 as b
  on a.unique1 = b.unique2
where
  b.unique2 is null;

set enable_memoize = off;

select 1 from tenk1 where (hundred, thousand) in (select twothousand, twothousand from onek);

reset enable_memoize;

select
  a.*
from
  tenk1 as a
where
  exists
  (
    select
      1
    from
      tenk1 as b
    where
      a.unique1 = b.unique2
    group by b.unique1
  );

create temporary table tt4x (
  c1 INT,
  c2 INT,
  c3 INT
);

select
  *
from
  tt4x as t1
where
  not exists
  (
    select
      1
    from
      tt4x as t2
      left outer join
        tt4x as t3
      on t2.c3 = t3.c1
      left outer join
        (
          select
            t5.c1 as c1
          from
            tt4x as t4
            left outer join
              tt4x as t5
            on t4.c2 = t5.c1
        )
        as a1
      on t3.c2 = a1.c1
    where
      t1.c1 = t2.c2
  );

create temporary table tt5 (
  f1 INT,
  f2 INT
);

create temporary table tt6 (
  f1 INT,
  f2 INT
);

insert into tt5 values (1, 10);

insert into tt5 values (1, 11);

insert into tt6 values (1, 9);

insert into tt6 values (1, 2);

insert into tt6 values (2, 9);

select * from tt5, tt6 where tt5.f1 = tt6.f1 and tt5.f1 = tt5.f2 - tt6.f2;

create temporary table xx (pkxx INT);

create temporary table yy (
  pkyy INT,
  pkxx INT
);

insert into xx values (1);

insert into xx values (2);

insert into xx values (3);

insert into yy values (101, 1);

insert into yy values (201, 2);

insert into yy values (301, null);

select
  yy.pkyy as yy_pkyy,
  yy.pkxx as yy_pkxx,
  yya.pkyy as yya_pkyy,
  xxa.pkxx as xxa_pkxx,
  xxb.pkxx as xxb_pkxx
from
  yy
  left outer join
    (select * from yy where pkyy = 101) as yya
  on yy.pkyy = yya.pkyy
  left outer join
    xx as xxa
  on yya.pkxx = xxa.pkxx
  left outer join
    xx as xxb
  on coalesce(xxa.pkxx, 1) = xxb.pkxx;

create temporary table zt1 (f1 INT primary key);

create temporary table zt2 (f2 INT primary key);

create temporary table zt3 (f3 INT primary key);

insert into zt1 values (53);

insert into zt2 values (53);

select * from zt2 left outer join zt3 on f2 = f3 left outer join zt1 on f3 = f1 where f2 = 53;

create temporary view zv1
as select *, cast('dummy' as TEXT) as junk from zt1;

select * from zt2 left outer join zt3 on f2 = f3 left outer join zv1 on f3 = f1 where f2 = 53;

select
  a.unique2,
  a.ten,
  b.tenthous,
  b.unique2,
  b.hundred
from
  tenk1 as a
  left outer join
    tenk1 as b
  on a.unique2 = b.tenthous
where
  a.unique1 = 42 and
  (b.unique2 is null and a.ten = 2 or b.hundred = 3);

prepare foo
(BOOLEAN)
as select
  COUNT(*)
from
  tenk1 as a
  left outer join
    tenk1 as b
  on a.unique2 = b.unique1 and
    exists
    (
      select
        1
      from
        tenk1 as c
      where
        c.thousand = b.unique2 and $1
    );;

execute foo (true);

execute foo (false);

begin;

set enable_mergejoin = 1;

set enable_hashjoin = 0;

set enable_nestloop = 0;

create temporary table a (i INT);

create temporary table b (
  x INT,
  y INT
);

select * from a left outer join b on i = x and i = y and x = i;

rollback;

begin;

create type mycomptype as (id INT, v BIGINT);

create temporary table tidv (idv mycomptype);

create index on tidv using btree (idv);

select a.idv, b.idv from tidv as a, tidv as b where a.idv = b.idv;

set enable_mergejoin = 0;

set enable_hashjoin = 0;

select a.idv, b.idv from tidv as a, tidv as b where a.idv = b.idv;

rollback;

select
  t1.q2,
  COUNT(t2.*)
from
  int8_tbl as t1
  left outer join
    int8_tbl as t2
  on t1.q2 = t2.q1
group by t1.q2
order by 1;

select
  t1.q2,
  COUNT(t2.*)
from
  int8_tbl as t1
  left outer join
    (select * from int8_tbl) as t2
  on t1.q2 = t2.q1
group by t1.q2
order by 1;

select
  t1.q2,
  COUNT(t2.*)
from
  int8_tbl as t1
  left outer join
    (select * from int8_tbl offset 0) as t2
  on t1.q2 = t2.q1
group by t1.q2
order by 1;

select
  t1.q2,
  COUNT(t2.*)
from
  int8_tbl as t1
  left outer join
    (
      select
        q1,
        case when q2 = 1 then 1 else q2 end as q2
      from
        int8_tbl
    )
    as t2
  on t1.q2 = t2.q1
group by t1.q2
order by 1;

begin;

create temporary table a (
  code CHAR(1) not null,
  constraint "a_pk" primary key (code)
);

create temporary table b (
  a CHAR(1) not null,
  num INT not null,
  constraint "b_pk" primary key (a, num)
);

create temporary table c (
  name CHAR(1) not null,
  a CHAR(1),
  constraint "c_pk" primary key (name)
);

insert into a (code) values ('p');

insert into a (code) values ('q');

insert into b (a, num) values ('p', 1);

insert into b (a, num) values ('p', 2);

insert into c (name, a) values ('A', 'p');

insert into c (name, a) values ('B', 'q');

insert into c (name, a) values ('C', null);

select
  c.name,
  ss.code,
  ss.b_cnt,
  ss.const
from
  c
  left outer join
    (
      select
        a.code,
        coalesce(b_grp.cnt, 0) as b_cnt,
        -1 as const
      from
        a
        left outer join
          (
            select COUNT(1) as cnt, b.a from b group by b.a
          )
          as b_grp
        on a.code = b_grp.a
    )
    as ss
  on c.a = ss.code
order by c.name;

rollback;

select
  *
from
  (select 1 as key1) as sub1
  left outer join
    (
      select
        sub3.key3,
        sub4.value2,
        coalesce(sub4.value2, 66) as value3
      from
        (select 1 as key3) as sub3
        left outer join
          (
            select
              sub5.key5,
              coalesce(sub6.value1, 1) as value2
            from
              (select 1 as key5) as sub5
              left outer join
                (select 2 as key6, 42 as value1) as sub6
              on sub5.key5 = sub6.key6
          )
          as sub4
        on sub4.key5 = sub3.key3
    )
    as sub2
  on sub1.key1 = sub2.key3;

select
  *
from
  (select 1 as key1) as sub1
  left outer join
    (
      select
        sub3.key3,
        value2,
        coalesce(value2, 66) as value3
      from
        (select 1 as key3) as sub3
        left outer join
          (
            select
              sub5.key5,
              coalesce(sub6.value1, 1) as value2
            from
              (select 1 as key5) as sub5
              left outer join
                (select 2 as key6, 42 as value1) as sub6
              on sub5.key5 = sub6.key6
          )
          as sub4
        on sub4.key5 = sub3.key3
    )
    as sub2
  on sub1.key1 = sub2.key3;

select
  qq,
  unique1
from
  (
    select coalesce(q1, 0) as qq from int8_tbl as a
  )
  as ss1
  full outer join
    (
      select coalesce(q2, -1) as qq from int8_tbl as b
    )
    as ss2
  using ("qq")
  inner join
    tenk1 as c
  on qq = unique2;

select
  qq,
  unique1
from
  (
    select coalesce(q1, 0) as qq from int8_tbl as a
  )
  as ss1
  full outer join
    (
      select coalesce(q2, -1) as qq from int8_tbl as b
    )
    as ss2
  using ("qq")
  inner join
    tenk1 as c
  on qq = unique2;

create temporary table nt1 (
  id INT primary key,
  a1 BOOLEAN,
  a2 BOOLEAN
);

create temporary table nt2 (
  id INT primary key,
  nt1_id INT,
  b1 BOOLEAN,
  b2 BOOLEAN,
  foreign key (nt1_id) references nt1 (id)
);

create temporary table nt3 (
  id INT primary key,
  nt2_id INT,
  c1 BOOLEAN,
  foreign key (nt2_id) references nt2 (id)
);

insert into nt1 values (1, true, true);

insert into nt1 values (2, true, false);

insert into nt1 values (3, false, false);

insert into nt2 values (1, 1, true, true);

insert into nt2 values (2, 2, true, false);

insert into nt2 values (3, 3, false, false);

insert into nt3 values (1, 1, true);

insert into nt3 values (2, 2, false);

insert into nt3 values (3, 3, true);

select
  nt3.id
from
  nt3 as nt3
  left outer join
    (
      select
        nt2.*,
        nt2.b1 and ss1.a3 as b3
      from
        nt2 as nt2
        left outer join
          (
            select nt1.*, nt1.id is not null as a3 from nt1
          )
          as ss1
        on ss1.id = nt2.nt1_id
    )
    as ss2
  on ss2.id = nt3.nt2_id
where
  nt3.id = 1 and ss2.b3;

select
  nt3.id
from
  nt3 as nt3
  left outer join
    (
      select
        nt2.*,
        nt2.b1 and ss1.a3 as b3
      from
        nt2 as nt2
        left outer join
          (
            select nt1.*, nt1.id is not null as a3 from nt1
          )
          as ss1
        on ss1.id = nt2.nt1_id
    )
    as ss2
  on ss2.id = nt3.nt2_id
where
  nt3.id = 1 and ss2.b3;

select
  *
from
  int8_tbl as t1
  left outer join
    (
      select q1 as x, 42 as y from int8_tbl as t2
    )
    as ss
  on t1.q2 = ss.x
where
  1 =
  (
    select
      1
    from
      int8_tbl as t3
    where
      ss.y is not null
    limit 1
  )
order by 1,
  2;

select
  *
from
  int8_tbl as t1
  left outer join
    (
      select q1 as x, 42 as y from int8_tbl as t2
    )
    as ss
  on t1.q2 = ss.x
where
  1 =
  (
    select
      1
    from
      int8_tbl as t3
    where
      ss.y is not null
    limit 1
  )
order by 1,
  2;

select
  *
from
  int4_tbl as i41,
  lateral (
    select
      1 as x
    from
      (
        select
          i41.f1 as lat,
          i42.f1 as loc
        from
          int8_tbl as i81,
          int4_tbl as i42
      )
      as ss1
      right outer join
        int4_tbl as i43
      on i43.f1 > 1
    where
      ss1.loc = ss1.lat
  )
  as ss2
where
  i41.f1 > 0;

select
  *
from
  int4_tbl as i41,
  lateral (
    select
      1 as x
    from
      (
        select
          i41.f1 as lat,
          i42.f1 as loc
        from
          int8_tbl as i81,
          int4_tbl as i42
      )
      as ss1
      right outer join
        int4_tbl as i43
      on i43.f1 > 1
    where
      ss1.loc = ss1.lat
  )
  as ss2
where
  i41.f1 > 0;

select * from int4_tbl as a full outer join int4_tbl as b on true;

select * from int4_tbl as a full outer join int4_tbl as b on false;

create temporary table q1 as select 1 as q1;

create temporary table q2 as select 0 as q2;

analyze q1;

analyze q2;

select
  *
from
  tenk1 inner join int4_tbl on f1 = twothousand,
  q1,
  q2
where
  q1 = thousand or q2 = thousand;

select * from tenk1 inner join int4_tbl on f1 = twothousand, q1, q2 where thousand = q1 + q2;

select
  *
from
  tenk1,
  int8_tbl as a,
  int8_tbl as b
where
  thousand = a.q1 and
  tenthous = b.q1 and
  a.q2 = 1 and
  b.q2 = 2;

select
  t1.unique2,
  t1.stringu1,
  t2.unique1,
  t2.stringu2
from
  tenk1 as t1
  inner join
    int4_tbl as i1
    left outer join
      (
        select
          v1.x2,
          v2.y1,
          11 as d1
        from
          (select 1, 0 from onerow) as v1 (x1, x2)
          left outer join
            (select 3, 1 from onerow) as v2 (y1, y2)
          on v1.x1 = v2.y2
      )
      as subq1
    on i1.f1 = subq1.x2
  on t1.unique2 = subq1.d1
  left outer join
    tenk1 as t2
  on subq1.y1 = t2.unique1
where
  t1.unique2 < 42 and t1.stringu1 > t2.stringu2;

select
  t1.unique2,
  t1.stringu1,
  t2.unique1,
  t2.stringu2
from
  tenk1 as t1
  inner join
    int4_tbl as i1
    left outer join
      (
        select
          v1.x2,
          v2.y1,
          11 as d1
        from
          (select 1, 0 from onerow) as v1 (x1, x2)
          left outer join
            (select 3, 1 from onerow) as v2 (y1, y2)
          on v1.x1 = v2.y2
      )
      as subq1
    on i1.f1 = subq1.x2
  on t1.unique2 = subq1.d1
  left outer join
    tenk1 as t2
  on subq1.y1 = t2.unique1
where
  t1.unique2 < 42 and t1.stringu1 > t2.stringu2;

select
  ss1.d1
from
  tenk1 as t1
  inner join
    tenk1 as t2
  on t1.tenthous = t2.ten
  inner join
    int8_tbl as i8
    left outer join
      int4_tbl as i4
      inner join
        (
          select
            cast(64 as information_schema.cardinal_number)
            as d1
          from
            tenk1 as t3,
            lateral (
              select abs(t3.unique1) + random()
            )
            as ss0 (x)
          where
            t3.fivethous < 0
        )
        as ss1
      on i4.f1 = ss1.d1
    on i8.q1 = i4.f1
  on t1.tenthous = ss1.d1
where
  t1.unique1 < i4.f1;

select
  ss1.d1
from
  tenk1 as t1
  inner join
    tenk1 as t2
  on t1.tenthous = t2.ten
  inner join
    int8_tbl as i8
    left outer join
      int4_tbl as i4
      inner join
        (
          select
            cast(64 as information_schema.cardinal_number)
            as d1
          from
            tenk1 as t3,
            lateral (
              select abs(t3.unique1) + random()
            )
            as ss0 (x)
          where
            t3.fivethous < 0
        )
        as ss1
      on i4.f1 = ss1.d1
    on i8.q1 = i4.f1
  on t1.tenthous = ss1.d1
where
  t1.unique1 < i4.f1;

select
  t1.unique2,
  t1.stringu1,
  t2.unique1,
  t2.stringu2
from
  tenk1 as t1
  inner join
    int4_tbl as i1
    left outer join
      (
        select
          v1.x2,
          v2.y1,
          11 as d1
        from
          (values (1, 0)) as v1 (x1, x2)
          left outer join
            (values (3, 1)) as v2 (y1, y2)
          on v1.x1 = v2.y2
      )
      as subq1
    on i1.f1 = subq1.x2
  on t1.unique2 = subq1.d1
  left outer join
    tenk1 as t2
  on subq1.y1 = t2.unique1
where
  t1.unique2 < 42 and t1.stringu1 > t2.stringu2;

select
  t1.unique2,
  t1.stringu1,
  t2.unique1,
  t2.stringu2
from
  tenk1 as t1
  inner join
    int4_tbl as i1
    left outer join
      (
        select
          v1.x2,
          v2.y1,
          11 as d1
        from
          (values (1, 0)) as v1 (x1, x2)
          left outer join
            (values (3, 1)) as v2 (y1, y2)
          on v1.x1 = v2.y2
      )
      as subq1
    on i1.f1 = subq1.x2
  on t1.unique2 = subq1.d1
  left outer join
    tenk1 as t2
  on subq1.y1 = t2.unique1
where
  t1.unique2 < 42 and t1.stringu1 > t2.stringu2;

select
  *
from
  (select 1 as x) as ss1
  left outer join
    (select 2 as y) as ss2
  on true,
  lateral (select ss2.y as z limit 1) as ss3;

select
  *
from
  (select 1 as x) as ss1
  left outer join
    (select 2 as y) as ss2
  on true,
  lateral (select ss2.y as z limit 1) as ss3;

begin;

set local from_collapse_limit = 2;

select
  *
from
  int8_tbl as t1
  left outer join
    (
      select
        coalesce(t2.q1 + x, 0)
      from
        int8_tbl as t2,
        lateral (
          select
            t3.q1 as x
          from
            int8_tbl as t3,
            lateral (select t2.q1, t3.q1 offset 0) as s
        )
    )
  on true;

rollback;

begin;

create temporary table t (i INT primary key);

select
  *
from
  t as t1
  left outer join
    (select 1 as x, * from t as t2 (i2)) as t2ss
  on t1.i = t2ss.i2
  left outer join
    t as t3 (i3)
  on false
  left outer join
    t as t4 (i4)
  on t4.i4 > t2ss.x;

select
  *
from
  (
    select
      k
    from
      (
        select
          i,
          coalesce(i, j) as k
        from
          (select i from t union all select 0)
          inner join
            (select 1 as j limit 1)
          on i = j
      )
      right outer join
        (select 2 as x)
      on true
      inner join
        (select 3 as y)
      on i is not null
  ),
  lateral (select k as kl limit 1);

rollback;

select
  *
from
  int8_tbl as i8
  inner join
    (
      select
        (select true) as x
      from
        int4_tbl as i4,
        lateral (select i4.f1 as y limit 1) as ss1
      where
        i4.f1 = 0
    )
    as ss2
  on true
  right outer join
    (select false as z) as ss3
  on true,
  lateral (
    select i8.q2 as q2l where x limit 1
  )
  as ss4
where
  i8.q2 = 123;

select
  *
from
  int8_tbl as i8
  inner join
    (
      select
        (select true) as x
      from
        int4_tbl as i4,
        lateral (select 1 as y limit 1) as ss1
      where
        i4.f1 = 0
    )
    as ss2
  on true
  right outer join
    (select false as z) as ss3
  on true,
  lateral (
    select i8.q2 as q2l where x limit 1
  )
  as ss4
where
  i8.q2 = 123;

select
  *
from
  (select 0 as z) as t1
  left outer join
    (select true as a) as t2
  on true,
  lateral (
    select true as b union all select a as b
  )
  as t3
where
  b;

select
  *
from
  (select 0 as z) as t1
  left outer join
    (select true as a) as t2
  on true,
  lateral (
    select true as b union all select a as b
  )
  as t3
where
  b;
