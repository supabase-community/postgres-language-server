---
source: crates/pgls_pretty_print/tests/tests.rs
input_file: crates/pgls_pretty_print/tests/data/multi/sqljson_queryfuncs.sql
snapshot_kind: text
---
select JSON_EXISTS(cast(null as JSONB), '$');

select JSON_EXISTS(cast('[]' as JSONB), '$');

select JSON_EXISTS(JSON_OBJECT(returning JSONB), '$');

select JSON_EXISTS(cast('1' as JSONB), '$');

select JSON_EXISTS(cast('null' as JSONB), '$');

select JSON_EXISTS(cast('[]' as JSONB), '$');

select JSON_EXISTS(cast('1' as JSONB), '$.a');

select JSON_EXISTS(cast('1' as JSONB), 'strict $.a');

select JSON_EXISTS(cast('1' as JSONB), 'strict $.a' error on error);

select JSON_EXISTS(cast('null' as JSONB), '$.a');

select JSON_EXISTS(cast('[]' as JSONB), '$.a');

select JSON_EXISTS(cast('[1, "aaa", {"a": 1}]' as JSONB), 'strict $.a');

select JSON_EXISTS(cast('[1, "aaa", {"a": 1}]' as JSONB), 'lax $.a');

select JSON_EXISTS(cast('{}' as JSONB), '$.a');

select JSON_EXISTS(cast('{"b": 1, "a": 2}' as JSONB), '$.a');

select JSON_EXISTS(cast('1' as JSONB), '$.a.b');

select JSON_EXISTS(cast('{"a": {"b": 1}}' as JSONB), '$.a.b');

select JSON_EXISTS(cast('{"a": 1, "b": 2}' as JSONB), '$.a.b');

select
  JSON_EXISTS(cast('{"a": 1, "b": 2}' as JSONB), '$.* ? (@ > $x)'
  passing 1 as x);

select
  JSON_EXISTS(cast('{"a": 1, "b": 2}' as JSONB), '$.* ? (@ > $x)'
  passing '1' as x);

select
  JSON_EXISTS(cast('{"a": 1, "b": 2}' as JSONB), '$.* ? (@ > $x && @ < $y)'
  passing 0 as x,
  2 as y);

select
  JSON_EXISTS(cast('{"a": 1, "b": 2}' as JSONB), '$.* ? (@ > $x && @ < $y)'
  passing 0 as x,
  1 as y);

select JSON_EXISTS(cast('1' as JSONB), '$ > 2');

select JSON_EXISTS(cast('1' as JSONB), '$.a > 2' error on error);

select JSON_VALUE(cast(null as JSONB), '$');

select JSON_VALUE(cast('null' as JSONB), '$');

select JSON_VALUE(cast('null' as JSONB), '$'  returning INT);

select JSON_VALUE(cast('true' as JSONB), '$');

select JSON_VALUE(cast('true' as JSONB), '$'  returning BOOLEAN);

select JSON_VALUE(cast('123' as JSONB), '$');

select JSON_VALUE(cast('123' as JSONB), '$'  returning INT) + 234;

select JSON_VALUE(cast('123' as JSONB), '$'  returning TEXT);

select JSON_VALUE(cast('123' as JSONB), '$'  returning BYTEA error on error);

select JSON_VALUE(cast('1.23' as JSONB), '$');

select JSON_VALUE(cast('1.23' as JSONB), '$'  returning INT);

select JSON_VALUE(cast('"1.23"' as JSONB), '$'  returning NUMERIC);

select JSON_VALUE(cast('"1.23"' as JSONB), '$'  returning INT error on error);

select JSON_VALUE(cast('"aaa"' as JSONB), '$');

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning TEXT);

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning CHAR(5));

select
  JSON_VALUE(cast('"aaa"' as JSONB), '$'
  returning CHAR(2)
  error on error);

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning CHAR(2));

select
  JSON_VALUE(cast('"aaa"' as JSONB), '$'
  returning CHAR(3)
  error on error);

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning JSON);

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning JSONB);

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning JSON error on error);

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning JSONB error on error);

select JSON_VALUE(cast('"\"aaa\""' as JSONB), '$'  returning JSON);

select JSON_VALUE(cast('"\"aaa\""' as JSONB), '$'  returning JSONB);

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning INT);

select JSON_VALUE(cast('"aaa"' as JSONB), '$'  returning INT error on error);

select
  JSON_VALUE(cast('"aaa"' as JSONB), '$'
  returning INT
  default 111 on error);

select JSON_VALUE(cast('"123"' as JSONB), '$'  returning INT) + 234;

select JSON_VALUE(cast('"2017-02-20"' as JSONB), '$'  returning DATE) + 9;

create domain sqljsonb_int_not_null as INT not null;

select JSON_VALUE(cast('null' as JSONB), '$'  returning sqljsonb_int_not_null);

select
  JSON_VALUE(cast('null' as JSONB), '$'
  returning sqljsonb_int_not_null
  error on error);

select
  JSON_VALUE(cast('null' as JSONB), '$'
  returning sqljsonb_int_not_null
  default 2 on EMPTY
  error on error);

select
  JSON_VALUE(cast('1' as JSONB), '$.a'
  returning sqljsonb_int_not_null
  default 2 on EMPTY
  error on error);

select
  JSON_VALUE(cast('1' as JSONB), '$.a'
  returning sqljsonb_int_not_null
  default null on EMPTY
  error on error);

create type rainbow as enum ('red',
'orange',
'yellow',
'green',
'blue',
'purple');

create domain rgb as rainbow check (value in ('red', 'green', 'blue'));

select JSON_VALUE(cast('"purple"' as JSONB), 'lax $[*]'  returning rgb);

select
  JSON_VALUE(cast('"purple"' as JSONB), 'lax $[*]'
  returning rgb
  error on error);

select JSON_VALUE(cast('[]' as JSONB), '$');

select JSON_VALUE(cast('[]' as JSONB), '$' error on error);

select JSON_VALUE(cast('{}' as JSONB), '$');

select JSON_VALUE(cast('{}' as JSONB), '$' error on error);

select JSON_VALUE(cast('1' as JSONB), '$.a');

select JSON_VALUE(cast('1' as JSONB), 'strict $.a' error on error);

select JSON_VALUE(cast('1' as JSONB), 'strict $.a' default 'error' on error);

select JSON_VALUE(cast('1' as JSONB), 'lax $.a' error on error);

select JSON_VALUE(cast('1' as JSONB), 'lax $.a' error on EMPTY error on error);

select JSON_VALUE(cast('1' as JSONB), 'strict $.*' default 2 on error);

select JSON_VALUE(cast('1' as JSONB), 'lax $.a' default 2 on error);

select JSON_VALUE(cast('1' as JSONB), 'lax $.a' default '2' on EMPTY);

select
  JSON_VALUE(cast('1' as JSONB), 'lax $.a'
  null on EMPTY
  default '2' on error);

select
  JSON_VALUE(cast('1' as JSONB), 'lax $.a'
  default '2' on EMPTY
  default '3' on error);

select
  JSON_VALUE(cast('1' as JSONB), 'lax $.a'
  error on EMPTY
  default '3' on error);

select JSON_VALUE(cast('[1,2]' as JSONB), '$[*]' error on error);

select JSON_VALUE(cast('[1,2]' as JSONB), '$[*]' default '0' on error);

select JSON_VALUE(cast('[" "]' as JSONB), '$[*]'  returning INT error on error);

select
  JSON_VALUE(cast('[" "]' as JSONB), '$[*]'
  returning INT
  default 2 + 3 on error);

select
  JSON_VALUE(cast('["1"]' as JSONB), '$[*]'
  returning INT
  default 2 + 3 on error);

select JSON_VALUE(cast('["1"]' as JSONB), '$[*]'  returning INT format json);

select JSON_VALUE(cast('["1"]' as JSONB), '$[*]'  returning RECORD);

select
  x,
  JSON_VALUE(cast('{"a": 1, "b": 2}' as JSONB), '$.* ? (@ > $x)'
  passing x as x
  returning INT
  default -1 on EMPTY
  default -2 on error)
  as y
from
  generate_series(0, 2) as x;

select
  JSON_VALUE(cast('null' as JSONB), '$a'
  passing cast(' (1, 2 )' as point) as a);

select
  JSON_VALUE(cast('null' as JSONB), '$a'
  passing cast(' (1, 2 )' as point) as a
  returning point);

select
  JSON_VALUE(cast('null' as JSONB), '$a'
  passing cast(' (1, 2 )' as point) as a
  returning point
  error on error);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as timestamp with time ZONE) as ts);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as timestamp with time ZONE) as ts
  returning timestamp with time ZONE);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as timestamp with time ZONE) as ts
  returning TIMESTAMP);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10' as DATE) as ts
  returning DATE);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10' as TIME) as ts
  returning TIME);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as time with time ZONE) as ts
  returning time with time ZONE);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as TIMESTAMP) as ts
  returning TIMESTAMP);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as timestamp with time ZONE) as ts
  returning JSON);

select
  JSON_VALUE(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as timestamp with time ZONE) as ts
  returning JSONB);

select JSON_VALUE('{"a": 1.234}', '$.a'  returning INT error on error);

select JSON_VALUE('{"a": "1.234"}', '$.a'  returning INT error on error);

select JSON_VALUE(cast(null as JSONB), '$');

select
  JSON_QUERY(js, '$') as unspec,
  JSON_QUERY(js, '$' without WRAPPER)
  as without,
  JSON_QUERY(js, '$'
  with CONDITIONAL WRAPPER)
  as "with cond",
  JSON_QUERY(js, '$'
  with UNCONDITIONAL WRAPPER)
  as "with uncond",
  JSON_QUERY(js, '$'
  with UNCONDITIONAL WRAPPER)
  as "with"
from
  (
    values
      (cast('null' as JSONB)),
      ('12.3'),
      ('true'),
      ('"aaa"'),
      ('[1, null, "2"]'),
      ('{"a": 1, "b": [2]}')
  )
  as foo (js);

select
  JSON_QUERY(js, 'strict $[*]') as unspec,
  JSON_QUERY(js, 'strict $[*]'
  without WRAPPER)
  as without,
  JSON_QUERY(js, 'strict $[*]'
  with CONDITIONAL WRAPPER)
  as "with cond",
  JSON_QUERY(js, 'strict $[*]'
  with UNCONDITIONAL WRAPPER)
  as "with uncond",
  JSON_QUERY(js, 'strict $[*]'
  with UNCONDITIONAL WRAPPER)
  as "with"
from
  (
    values
      (cast('1' as JSONB)),
      ('[]'),
      ('[null]'),
      ('[12.3]'),
      ('[true]'),
      ('["aaa"]'),
      ('[[1, 2, 3]]'),
      ('[{"a": 1, "b": [2]}]'),
      ('[1, "2", null, [3]]')
  )
  as foo (js);

select JSON_QUERY(cast('"aaa"' as JSONB), '$'  returning TEXT);

select JSON_QUERY(cast('"aaa"' as JSONB), '$'  returning TEXT KEEP QUOTES);

select JSON_QUERY(cast('"aaa"' as JSONB), '$'  returning TEXT KEEP QUOTES);

select JSON_QUERY(cast('"aaa"' as JSONB), '$'  returning TEXT OMIT QUOTES);

select JSON_QUERY(cast('"aaa"' as JSONB), '$'  returning TEXT OMIT QUOTES);

select JSON_QUERY(cast('"aaa"' as JSONB), '$' OMIT QUOTES error on error);

select
  JSON_QUERY(cast('"aaa"' as JSONB), '$'
  returning JSON
  OMIT QUOTES
  error on error);

select
  JSON_QUERY(cast('"aaa"' as JSONB), '$'
  returning BYTEA format json
  OMIT QUOTES
  error on error);

select
  JSON_QUERY(cast('"aaa"' as JSONB), '$'
  returning CHAR(3)
  error on error);

select JSON_QUERY(cast('"aaa"' as JSONB), '$'  returning CHAR(3));

select
  JSON_QUERY(cast('"aaa"' as JSONB), '$'
  returning CHAR(3)
  OMIT QUOTES
  error on error);

select
  JSON_QUERY(cast('"aaa"' as JSONB), '$.a'
  returning CHAR(2)
  OMIT QUOTES
  default 'bb' on EMPTY);

select
  JSON_QUERY(cast('"aaa"' as JSONB), '$.a'
  returning CHAR(2)
  OMIT QUOTES
  default cast('"bb"' as JSONB) on EMPTY);

select
  JSON_QUERY(cast('[1]' as JSONB), '$'
  with UNCONDITIONAL WRAPPER
  OMIT QUOTES);

select
  JSON_QUERY(cast('[1]' as JSONB), '$'
  with CONDITIONAL WRAPPER
  OMIT QUOTES);

select
  JSON_QUERY(cast('["1"]' as JSONB), '$[*]'
  with CONDITIONAL WRAPPER
  KEEP QUOTES);

select
  JSON_QUERY(cast('["1"]' as JSONB), '$[*]'
  with UNCONDITIONAL WRAPPER
  KEEP QUOTES);

select
  JSON_QUERY(cast('["1"]' as JSONB), '$[*]'
  with UNCONDITIONAL WRAPPER
  KEEP QUOTES);

select JSON_QUERY(cast('["1"]' as JSONB), '$[*]' without WRAPPER OMIT QUOTES);

select JSON_QUERY(cast('["1"]' as JSONB), '$[*]' without WRAPPER KEEP QUOTES);

select
  JSON_QUERY(cast('{"rec": "{1,2,3}"}' as JSONB), '$.rec'
  returning INT[]
  OMIT QUOTES);

select
  JSON_QUERY(cast('{"rec": "{1,2,3}"}' as JSONB), '$.rec'
  returning INT[]
  KEEP QUOTES);

select
  JSON_QUERY(cast('{"rec": "{1,2,3}"}' as JSONB), '$.rec'
  returning INT[]
  KEEP QUOTES
  error on error);

select
  JSON_QUERY(cast('{"rec": "[1,2]"}' as JSONB), '$.rec'
  returning INT4RANGE
  OMIT QUOTES);

select
  JSON_QUERY(cast('{"rec": "[1,2]"}' as JSONB), '$.rec'
  returning INT4RANGE
  KEEP QUOTES);

select
  JSON_QUERY(cast('{"rec": "[1,2]"}' as JSONB), '$.rec'
  returning INT4RANGE
  KEEP QUOTES
  error on error);

create domain qf_char_domain as CHAR(1);

create domain qf_jsonb_domain as JSONB;

select
  JSON_QUERY(cast('"1"' as JSONB), '$'
  returning qf_char_domain
  OMIT QUOTES
  error on error);

select
  JSON_QUERY(cast('"1"' as JSONB), '$'
  returning qf_jsonb_domain
  OMIT QUOTES
  error on error);

drop DOMAIN qf_char_domain, qf_jsonb_domain;

select JSON_QUERY(cast('[]' as JSONB), '$[*]');

select JSON_QUERY(cast('[]' as JSONB), '$[*]' null on EMPTY);

select JSON_QUERY(cast('[]' as JSONB), '$[*]' EMPTY ARRAY on EMPTY);

select JSON_QUERY(cast('[]' as JSONB), '$[*]' EMPTY ARRAY on EMPTY);

select JSON_QUERY(cast('[]' as JSONB), '$[*]' EMPTY OBJECT on EMPTY);

select JSON_QUERY(cast('[]' as JSONB), '$[*]' error on EMPTY);

select JSON_QUERY(cast('[]' as JSONB), '$[*]' default '"empty"' on EMPTY);

select JSON_QUERY(cast('[]' as JSONB), '$[*]' error on EMPTY null on error);

select
  JSON_QUERY(cast('[]' as JSONB), '$[*]'
  error on EMPTY
  EMPTY ARRAY on error);

select
  JSON_QUERY(cast('[]' as JSONB), '$[*]'
  error on EMPTY
  EMPTY OBJECT on error);

select JSON_QUERY(cast('[]' as JSONB), '$[*]' error on EMPTY error on error);

select JSON_QUERY(cast('[]' as JSONB), '$[*]' error on error);

select JSON_QUERY(cast('[1,2]' as JSONB), '$[*]' error on error);

select JSON_QUERY(cast('[1,2]' as JSONB), '$[*]' default '"empty"' on error);

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning JSON);

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning JSON format json);

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning JSONB);

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning JSONB format json);

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning TEXT);

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning CHAR(10));

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning TEXT format json);

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning BYTEA);

select JSON_QUERY(cast('[1,2]' as JSONB), '$'  returning BYTEA format json);

select
  JSON_QUERY(cast('[1,2]' as JSONB), '$[*]'
  returning BYTEA
  EMPTY OBJECT on error);

select
  JSON_QUERY(cast('[1,2]' as JSONB), '$[*]'
  returning BYTEA format json
  EMPTY OBJECT on error);

select
  JSON_QUERY(cast('[1,2]' as JSONB), '$[*]'
  returning JSON
  EMPTY OBJECT on error);

select
  JSON_QUERY(cast('[1,2]' as JSONB), '$[*]'
  returning JSONB
  EMPTY OBJECT on error);

select
  JSON_QUERY(cast('[3,4]' as JSONB), '$[*]'
  returning BIGINT[]
  EMPTY OBJECT on error);

select
  JSON_QUERY(cast('"[3,4]"' as JSONB), '$[*]'
  returning BIGINT[]
  EMPTY OBJECT on error);

select
  JSON_QUERY(cast('"123.1"' as JSONB), '$'
  returning SMALLINT
  error on error);

select JSON_QUERY(cast('"123.1"' as JSONB), '$'  returning INT error on error);

select
  JSON_QUERY(cast('"123.1"' as JSONB), '$'
  returning BIGINT
  error on error);

select
  JSON_QUERY(cast('"123.1"' as JSONB), '$'
  returning BOOLEAN
  error on error);

select
  JSON_QUERY(cast('"123.1"' as JSONB), '$'
  returning NUMERIC
  error on error);

select JSON_QUERY(cast('"123.1"' as JSONB), '$'  returning REAL error on error);

select
  JSON_QUERY(cast('"123.1"' as JSONB), '$'
  returning DOUBLE PRECISION
  error on error);

select
  JSON_QUERY(cast('"123.1"' as JSONB), '$'
  returning SMALLINT
  OMIT QUOTES
  error on error);

select
  JSON_QUERY(cast('"123.1"' as JSONB), '$'
  returning DOUBLE PRECISION
  OMIT QUOTES
  error on error);

select
  JSON_QUERY(cast('[3,4]' as JSONB), '$[*]'
  returning ANYARRAY
  EMPTY OBJECT on error);

select
  x,
  y,
  JSON_QUERY(cast('[1,2,3,4,5,null]' as JSONB), '$[*] ? (@ >= $x && @ <= $y)'
  passing x as x,
  y as y
  with CONDITIONAL WRAPPER
  EMPTY ARRAY on EMPTY)
  as list
from
  generate_series(0, 4) as x,
  generate_series(0, 4) as y;

create type comp_abc as (a TEXT, b INT, c TIMESTAMP);

select
  JSON_QUERY(cast('{"rec": "(abc,42,01.02.2003)"}'
  as JSONB), '$.rec'
  returning comp_abc
  OMIT QUOTES);

select
  JSON_QUERY(cast('{"rec": "(abc,42,01.02.2003)"}'
  as JSONB), '$.rec'
  returning comp_abc
  KEEP QUOTES);

select
  JSON_QUERY(cast('{"rec": "(abc,42,01.02.2003)"}'
  as JSONB), '$.rec'
  returning comp_abc
  KEEP QUOTES
  error on error);

drop TYPE comp_abc;

create type sqljsonb_rec as (a INT, t TEXT, js JSON, jb JSONB, jsa JSON[]);

create type sqljsonb_reca as (reca sqljsonb_rec[]);

select
  JSON_QUERY(cast('[{"a": 1, "b": "foo", "t": "aaa", "js": [1, "2", {}], "jb": {"x": [1, "2", {}]}},  {"a": 2}]'
  as JSONB), '$[0]'
  returning sqljsonb_rec);

select
  JSON_QUERY(cast('[{"a": "a", "b": "foo", "t": "aaa", "js": [1, "2", {}], "jb": {"x": [1, "2", {}]}},  {"a": 2}]'
  as JSONB), '$[0]'
  returning sqljsonb_rec
  error on error);

select
  JSON_QUERY(cast('[{"a": "a", "b": "foo", "t": "aaa", "js": [1, "2", {}], "jb": {"x": [1, "2", {}]}},  {"a": 2}]'
  as JSONB), '$[0]'
  returning sqljsonb_rec);

select
  *
from
  unnest(
    (JSON_QUERY(cast('{"jsa":  [{"a": 1, "b": ["foo"]}, {"a": 2, "c": {}}, 123]}'
    as JSONB), '$'
    returning sqljsonb_rec)).jsa
  );

select
  *
from
  unnest(
    (JSON_QUERY(cast('{"reca": [{"a": 1, "t": ["foo", []]}, {"a": 2, "jb": [{}, true]}]}'
    as JSONB), '$'
    returning sqljsonb_reca)).reca
  );

select
  JSON_QUERY(cast('[{"a": 1, "b": "foo", "t": "aaa", "js": [1, "2", {}], "jb": {"x": [1, "2", {}]}},  {"a": 2}]'
  as JSONB), '$[0]'
  returning jsonpath);

select
  JSON_QUERY(cast('[{"a": 1, "b": "foo", "t": "aaa", "js": [1, "2", {}], "jb": {"x": [1, "2", {}]}},  {"a": 2}]'
  as JSONB), '$[0]'
  returning jsonpath
  error on error);

select
  JSON_QUERY(cast('[1,2,null,"3"]' as JSONB), '$[*]'
  returning INT[]
  with UNCONDITIONAL WRAPPER);

select
  JSON_QUERY(cast('[1,2,null,"a"]' as JSONB), '$[*]'
  returning INT[]
  with UNCONDITIONAL WRAPPER
  error on error);

select
  JSON_QUERY(cast('[1,2,null,"a"]' as JSONB), '$[*]'
  returning INT[]
  with UNCONDITIONAL WRAPPER);

select
  *
from
  unnest(
    JSON_QUERY(cast('[{"a": 1, "t": ["foo", []]}, {"a": 2, "jb": [{}, true]}]'
    as JSONB), '$'
    returning sqljsonb_rec[])
  );

select
  JSON_QUERY(cast('{"a": 1}' as JSONB), '$.a'
  returning sqljsonb_int_not_null);

select
  JSON_QUERY(cast('{"a": 1}' as JSONB), '$.b'
  returning sqljsonb_int_not_null);

select
  JSON_QUERY(cast('{"a": 1}' as JSONB), '$.b'
  returning sqljsonb_int_not_null
  error on EMPTY
  error on error);

select
  JSON_QUERY(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as timestamp with time ZONE) as ts);

select
  JSON_QUERY(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as timestamp with time ZONE) as ts
  returning JSON);

select
  JSON_QUERY(cast('null' as JSONB), '$ts'
  passing cast('2018-02-21 12:34:56 +10'
  as timestamp with time ZONE) as ts
  returning JSONB);

create table test_jsonb_constraints (
  js TEXT,
  i INT,
  x JSONB
  default JSON_QUERY(cast('[1,2]' as JSONB), '$[*]'
  with UNCONDITIONAL WRAPPER)
  constraint "test_jsonb_constraint1" check (js is JSON)
  constraint "test_jsonb_constraint2" check (JSON_EXISTS(cast(js as JSONB), '$.a'
  passing i + 5 as int,
  cast(i as TEXT) as "TXT",
  array[1, 2, 3] as arr))
  constraint "test_jsonb_constraint3" check (JSON_VALUE(cast(js as JSONB), '$.a'
  returning INT
  default '12' on EMPTY
  error on error) >
  i)
  constraint "test_jsonb_constraint4" check (JSON_QUERY(cast(js as JSONB), '$.a'
  with CONDITIONAL WRAPPER
  EMPTY OBJECT on error) =
  cast('[10]' as JSONB))
  constraint "test_jsonb_constraint5" check (JSON_QUERY(cast(js as JSONB), '$.a'
  returning CHAR(5)
  OMIT QUOTES
  EMPTY ARRAY on EMPTY) >
  'a' collate "C")
);

select
  check_clause
from
  information_schema.check_constraints
where
  constraint_name like 'test_jsonb_constraint%'
order by 1;

select
  pg_get_expr(adbin, adrelid)
from
  pg_attrdef
where
  adrelid =
  cast('test_jsonb_constraints'
  as REGCLASS)
order by 1;

insert into test_jsonb_constraints values ('', 1);

insert into test_jsonb_constraints values ('1', 1);

insert into test_jsonb_constraints values ('[]');

insert into test_jsonb_constraints values ('{"b": 1}', 1);

insert into test_jsonb_constraints values ('{"a": 1}', 1);

insert into test_jsonb_constraints values ('{"a": 10}', 1);

drop TABLE "test_jsonb_constraints";

create table test_jsonb_mutability (
  js JSONB,
  b INT
);

create index on test_jsonb_mutability using btree ((JSON_QUERY(js, '$')));

create index on test_jsonb_mutability using btree ((JSON_QUERY(js, '$.a[0]')));

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.time()'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.date()'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.time_tz()'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.timestamp()'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.timestamp_tz()'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.date() < $.time_tz())'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.date() < $.time())'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.time() < $.time())'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.time() < $.time_tz())'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.timestamp() < $.timestamp_tz())'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.timestamp_tz() < $.timestamp_tz())'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.time() < $.datetime("HH:MI TZH"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.date() < $.datetime("HH:MI TZH"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.timestamp() < $.datetime("HH:MI TZH"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.timestamp() < $.datetime("HH:MI"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.timestamp_tz() < $.datetime("HH:MI TZH"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.timestamp_tz() < $.datetime("HH:MI"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.date() < $x'
  passing cast('12:34' as time with time ZONE) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.date() < $x'
  passing cast('1234' as INT) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.timestamp(2) < $.timestamp(3))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.datetime()'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@ < $.datetime())'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.datetime() < $.datetime())'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.datetime() < $.datetime("HH:MI TZH"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.datetime("HH:MI TZH") < $.datetime("HH:MI TZH"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.datetime("HH:MI") < $.datetime("YY-MM-DD HH:MI"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.a ? (@.datetime("HH:MI TZH") < $.datetime("YY-MM-DD HH:MI"))'))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.datetime("HH:MI TZH") < $x'
  passing cast('12:34' as time with time ZONE) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.datetime("HH:MI TZH") < $y'
  passing cast('12:34' as time with time ZONE) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.datetime() < $x'
  passing cast('12:34' as time with time ZONE) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.datetime() < $x'
  passing cast('1234' as INT) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.datetime() ? (@ == $x)'
  passing cast('12:34' as TIME) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$.datetime("YY-MM-DD") ? (@ == $x)'
  passing cast('2020-07-14' as DATE) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$[1, $.a ? (@.datetime() == $x)]'
  passing cast('12:34' as TIME) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$[1, 0 to $.a ? (@.datetime() == $x)]'
  passing cast('12:34' as TIME) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_QUERY(js, '$[1, $.a ? (@.datetime("HH:MI") == $x)]'
  passing cast('12:34' as TIME) as x))
);

create index
on test_jsonb_mutability
using btree
(
  (JSON_VALUE(js, '$'
  default cast(random() as INT) on error))
);

create or replace function ret_setint()
returns setof INT
as '
BEGIN
    RETURN QUERY EXECUTE ''select 1 union all select 1'';
END;
'
language "plpgsql"
immutable;

select
  JSON_QUERY(js, '$'
  returning INT
  default ret_setint() on error)
from
  test_jsonb_mutability;

select
  JSON_QUERY(js, '$'
  returning INT
  default b + 1 on error)
from
  test_jsonb_mutability;

select
  JSON_QUERY(js, '$'
  returning INT
  default SUM(1) over () on error)
from
  test_jsonb_mutability;

select
  JSON_QUERY(js, '$'
  returning INT
  default (select 1) on error)
from
  test_jsonb_mutability;

drop TABLE "test_jsonb_mutability";

drop FUNCTION ret_setint;

create domain queryfuncs_test_domain as TEXT check (value <> 'foo');

select
  JSON_VALUE(cast('{"d1": "H"}' as JSONB), '$.a2'
  returning queryfuncs_test_domain
  default cast('foo' as queryfuncs_test_domain) on EMPTY);

select
  JSON_VALUE(cast('{"d1": "H"}' as JSONB), '$.a2'
  returning queryfuncs_test_domain
  default cast('foo1' as queryfuncs_test_domain) on EMPTY);

select
  JSON_VALUE(cast('{"d1": "H"}' as JSONB), '$.a2'
  returning queryfuncs_test_domain
  default cast(cast('"foo1"' as JSONB) as TEXT) on EMPTY);

select
  JSON_VALUE(cast('{"d1": "foo"}' as JSONB), '$.a2'
  returning queryfuncs_test_domain
  default cast('foo1' as queryfuncs_test_domain) on EMPTY);

select
  JSON_QUERY('"a"', '$.a'
  returning INT
  default cast((select '"1"') as JSONB) on error);

select
  JSON_QUERY('"a"', '$.a'
  returning queryfuncs_test_domain
  default cast((select '"1"')
  as queryfuncs_test_domain) on error);

select
  JSON_QUERY('"a"', '$.a'
  returning INT
  default cast(cast((select 1) as OID) as INT) on error);

select
  JSON_QUERY('"a"', '$.a'
  returning INT[]
  default cast(cast((select '{1}') as OID[])
  as INT[]) on error);

select
  JSON_QUERY('"a"', '$.a'
  returning INT[]
  default cast((select '{1}') as TEXT) collate "C" on error);

create table someparent (a INT);

create table somechild ()
inherits (someparent);

select
  JSON_QUERY('"a"', '$.a'
  returning someparent
  default cast(cast((select '(1)') as somechild)
  as someparent) on error);

drop DOMAIN queryfuncs_test_domain;

drop TABLE "someparent", "somechild";

select JSON_EXISTS(cast('{"a": 123}' as JSONB), '$' || '.' || 'a');

select JSON_VALUE(cast('{"a": 123}' as JSONB), '$' || '.' || 'a');

select
  JSON_VALUE(cast('{"a": 123}' as JSONB), '$' || '.' || 'b'
  default 'foo' on EMPTY);

select JSON_QUERY(cast('{"a": 123}' as JSONB), '$' || '.' || 'a');

select
  JSON_QUERY(cast('{"a": 123}' as JSONB), '$' || '.' || 'a'
  with UNCONDITIONAL WRAPPER);

select JSON_QUERY(cast('{"a": 123}' as JSONB), 'error' || ' ' || 'error');

select JSON_EXISTS(cast('{"a": 123}' as JSON), '$' || '.' || 'a');

select JSON_QUERY(null format json, '$');

create temporary table jsonpaths (path) as select '$';

select JSON_VALUE('"aaa"', path  returning JSON) from jsonpaths;

select JSON_QUERY(cast('null' as JSONB), '$xyz' passing 1 as xy);

select JSON_QUERY(cast('null' as JSONB), '$xy' passing 1 as xyz);

select JSON_QUERY(cast('null' as JSONB), '$xyz' passing 1 as xyz);

select JSON_QUERY(cast('null' as JSONB), '$Xyz' passing 1 as xyz);

select JSON_QUERY(cast('null' as JSONB), '$Xyz' passing 1 as "Xyz");

select JSON_QUERY(cast('null' as JSONB), '$"Xyz"' passing 1 as "Xyz");

select JSON_EXISTS(cast('1' as JSONB), '$' default 1 on error);

select JSON_VALUE(cast('1' as JSONB), '$' EMPTY ARRAY on error);

select JSON_QUERY(cast('1' as JSONB), '$' true on error);

create domain queryfuncs_char2 as CHAR(2);

create domain queryfuncs_char2_chk as CHAR(2) check (value not in ('12'));

select
  JSON_QUERY(cast('123' as JSONB), '$'
  returning queryfuncs_char2
  error on error);

select
  JSON_QUERY(cast('123' as JSONB), '$'
  returning queryfuncs_char2
  default '1' on error);

select
  JSON_QUERY(cast('123' as JSONB), '$'
  returning queryfuncs_char2_chk
  error on error);

select
  JSON_QUERY(cast('123' as JSONB), '$'
  returning queryfuncs_char2_chk
  default '1' on error);

select
  JSON_VALUE(cast('123' as JSONB), '$'
  returning queryfuncs_char2
  error on error);

select
  JSON_VALUE(cast('123' as JSONB), '$'
  returning queryfuncs_char2
  default 1 on error);

select
  JSON_VALUE(cast('123' as JSONB), '$'
  returning queryfuncs_char2_chk
  error on error);

select
  JSON_VALUE(cast('123' as JSONB), '$'
  returning queryfuncs_char2_chk
  default 1 on error);

drop DOMAIN queryfuncs_char2, queryfuncs_char2_chk;

create domain queryfuncs_d_varbit3 as BIT VARYING(3) check (value <> '01');

select
  JSON_VALUE(cast('1234' as JSONB), '$'
  returning queryfuncs_d_varbit3
  default '111111' on error);

select
  JSON_VALUE(cast('1234' as JSONB), '$'
  returning queryfuncs_d_varbit3
  default '010' on error);

select
  JSON_VALUE(cast('1234' as JSONB), '$'
  returning queryfuncs_d_varbit3
  default '01' on error);

select JSON_VALUE(cast('"111"' as JSONB), '$'  returning BIT(2) error on error);

select
  JSON_VALUE(cast('1234' as JSONB), '$'
  returning BIT(3)
  default 1 on error);

select
  JSON_VALUE(cast('1234' as JSONB), '$'
  returning BIT(3)
  default cast(1 as BIT(3)) on error);

select
  JSON_VALUE(cast('"111"' as JSONB), '$.a'
  returning BIT(3)
  default '1111' on EMPTY);

drop DOMAIN queryfuncs_d_varbit3;
