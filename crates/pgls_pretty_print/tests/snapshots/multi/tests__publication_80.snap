---
source: crates/pgls_pretty_print/tests/tests.rs
input_file: crates/pgls_pretty_print/tests/data/multi/publication.sql
snapshot_kind: text
---
create role regress_publication_user LOGIN SUPERUSER;

create role regress_publication_user2;

create role regress_publication_user_dummy LOGIN NOSUPERUSER;

set session authorization regress_publication_user;

set client_min_messages = ERROR;

create PUBLICATION testpub_default;

reset client_min_messages;

comment on publication testpub_default is 'test publication';

select obj_description(p.oid, 'pg_publication') from pg_publication as p;

set client_min_messages = ERROR;

create PUBLICATION testpub_ins_trunct with (publish = insert);

reset client_min_messages;

alter PUBLICATION testpub_default set (publish = update);

create PUBLICATION testpub_xxx with (foo);

create PUBLICATION testpub_xxx with (publish = 'cluster, vacuum');

create PUBLICATION testpub_xxx
with (publish_via_partition_root = 'true',
publish_via_partition_root = '0');

create PUBLICATION testpub_xxx
with (publish_generated_columns = stored,
publish_generated_columns = 'none');

create PUBLICATION testpub_xxx with (publish_generated_columns = foo);

create PUBLICATION testpub_xxx with (publish_generated_columns);

alter PUBLICATION testpub_default set (publish = 'insert, update, delete');

create schema "pub_test";

create table testpub_tbl1 (
  id serial primary key,
  data TEXT
);

create table pub_test.testpub_nopk (
  foo INT,
  bar INT
);

create view testpub_view
as select 1;

create table testpub_parted (a INT)
partition by LIST(a);

set client_min_messages = ERROR;

create PUBLICATION testpub_foralltables for all TABLES
with (publish = 'insert');

reset client_min_messages;

alter PUBLICATION testpub_foralltables set (publish = 'insert, update');

create table testpub_tbl2 (
  id serial primary key,
  data TEXT
);

alter PUBLICATION testpub_foralltables add table testpub_tbl2;

alter PUBLICATION testpub_foralltables drop table testpub_tbl2;

alter PUBLICATION testpub_foralltables set table pub_test.testpub_nopk;

alter PUBLICATION testpub_foralltables add TABLES in SCHEMA pub_test;

alter PUBLICATION testpub_foralltables drop TABLES in SCHEMA pub_test;

alter PUBLICATION testpub_foralltables set TABLES in SCHEMA pub_test;

set client_min_messages = ERROR;

create PUBLICATION testpub_fortable for table testpub_tbl1;

reset client_min_messages;

alter PUBLICATION testpub_fortable add TABLES in SCHEMA pub_test;

alter PUBLICATION testpub_fortable drop TABLES in SCHEMA pub_test;

alter PUBLICATION testpub_fortable set TABLES in SCHEMA pub_test;

set client_min_messages = ERROR;

create PUBLICATION testpub_forschema for TABLES in SCHEMA pub_test;

create PUBLICATION testpub_for_tbl_schema
for TABLES in SCHEMA pub_test,
table pub_test.testpub_nopk;

reset client_min_messages;

alter PUBLICATION testpub_forschema add table pub_test.testpub_nopk;

alter PUBLICATION testpub_forschema drop table pub_test.testpub_nopk;

alter PUBLICATION testpub_forschema drop table pub_test.testpub_nopk;

alter PUBLICATION testpub_forschema set table pub_test.testpub_nopk;

select
  pubname,
  puballtables
from
  pg_publication
where
  pubname = 'testpub_foralltables';

drop TABLE "testpub_tbl2";

drop PUBLICATION
  testpub_foralltables,
  testpub_fortable,
  testpub_forschema,
  testpub_for_tbl_schema;

create table testpub_tbl3 (a INT);

create table testpub_tbl3a (b TEXT)
inherits (testpub_tbl3);

set client_min_messages = ERROR;

create PUBLICATION testpub3 for table testpub_tbl3;

create PUBLICATION testpub4 for table only testpub_tbl3;

reset client_min_messages;

drop TABLE "testpub_tbl3", "testpub_tbl3a";

drop PUBLICATION testpub3, testpub4;

set client_min_messages = ERROR;

create PUBLICATION testpub_forparted;

create PUBLICATION testpub_forparted1;

reset client_min_messages;

create table testpub_parted1 (like testpub_parted);

create table testpub_parted2 (like testpub_parted);

alter PUBLICATION testpub_forparted1 set (publish = 'insert');

alter table testpub_parted
  ATTACH partition
  testpub_parted1 for values in (1);

alter table testpub_parted
  ATTACH partition
  testpub_parted2 for values in (2);

update testpub_parted1 set a = 1;

alter PUBLICATION testpub_forparted add table testpub_parted;

update testpub_parted set a = 1 where false;

update testpub_parted1 set a = 1;

alter table testpub_parted
  DETACH partition
  testpub_parted1;

update testpub_parted1 set a = 1;

alter PUBLICATION testpub_forparted set (publish_via_partition_root = 'true');

update testpub_parted2 set a = 2;

alter PUBLICATION testpub_forparted drop table testpub_parted;

update testpub_parted2 set a = 2;

drop TABLE "testpub_parted1", "testpub_parted2";

drop PUBLICATION testpub_forparted, testpub_forparted1;

create table testpub_rf_tbl1 (
  a INT,
  b TEXT
);

create table testpub_rf_tbl2 (
  c TEXT,
  d INT
);

create table testpub_rf_tbl3 (e INT);

create table testpub_rf_tbl4 (g TEXT);

create table testpub_rf_tbl5 (a XML);

create schema "testpub_rf_schema1";

create table testpub_rf_schema1.testpub_rf_tbl5 (h INT);

create schema "testpub_rf_schema2";

create table testpub_rf_schema2.testpub_rf_tbl6 (i INT);

set client_min_messages = ERROR;

create PUBLICATION testpub5
for table testpub_rf_tbl1,
table testpub_rf_tbl2 where (c <> 'test' and d < 5)
with (publish = 'insert');

reset client_min_messages;

alter PUBLICATION testpub5 add
table testpub_rf_tbl3
where (
  e > 1000 and e < 2000);

alter PUBLICATION testpub5 drop table testpub_rf_tbl2;

alter PUBLICATION testpub5 set
table testpub_rf_tbl3
where (
  e > 300 and e < 500);

set client_min_messages = ERROR;

create PUBLICATION testpub_rf_yes
for table testpub_rf_tbl1 where (a > 1)
with (publish = 'insert');

create PUBLICATION testpub_rf_no for table testpub_rf_tbl1;

reset client_min_messages;

drop PUBLICATION testpub_rf_yes, testpub_rf_no;

set client_min_messages = ERROR;

create PUBLICATION testpub_syntax1
for table testpub_rf_tbl1,
table only testpub_rf_tbl3 where (e < 999)
with (publish = 'insert');

reset client_min_messages;

drop PUBLICATION testpub_syntax1;

set client_min_messages = ERROR;

create PUBLICATION testpub_syntax2
for table testpub_rf_tbl1,
table testpub_rf_schema1.testpub_rf_tbl5 where (h < 999)
with (publish = 'insert');

reset client_min_messages;

drop PUBLICATION testpub_syntax2;

set client_min_messages = ERROR;

reset client_min_messages;

set client_min_messages = ERROR;

create PUBLICATION testpub_dups
for table testpub_rf_tbl1 where (a = 1),
table testpub_rf_tbl1
with (publish = 'insert');

create PUBLICATION testpub_dups
for table testpub_rf_tbl1,
table testpub_rf_tbl1 where (a = 2)
with (publish = 'insert');

reset client_min_messages;

alter PUBLICATION testpub5 set table testpub_rf_tbl3 where ( 1234);

alter PUBLICATION testpub5 set table testpub_rf_tbl3 where ( e < AVG(e));

create function testpub_rf_func1(INT, INT)
returns BOOLEAN
as ' SELECT hashint4($1) > $2 '
language "sql";

create operator =#> (PROCEDURE = testpub_rf_func1,
LEFTARG = INT,
RIGHTARG = INT);

create PUBLICATION testpub6 for table testpub_rf_tbl3 where (e =#> 27);

create function testpub_rf_func2()
returns INT
immutable
as ' BEGIN RETURN 123; END; '
language "plpgsql";

alter PUBLICATION testpub5 add
table testpub_rf_tbl1
where (
  a >= testpub_rf_func2());

alter PUBLICATION testpub5 add table testpub_rf_tbl1 where ( a < random());

create collation user_collation from "C";

alter PUBLICATION testpub5 add
table testpub_rf_tbl1
where (
  b < '2' collate "user_collation");

alter PUBLICATION testpub5 set table testpub_rf_tbl1 where ( nullif(1, 2) = a);

alter PUBLICATION testpub5 set table testpub_rf_tbl1 where ( a is null);

alter PUBLICATION testpub5 set table testpub_rf_tbl1 where ( a > 5 is false);

alter PUBLICATION testpub5 set
table testpub_rf_tbl1
where (
  a is distinct from 5);

alter PUBLICATION testpub5 set
table testpub_rf_tbl1
where (
  (a, a + 1) < (2, 3));

alter PUBLICATION testpub5 set
table testpub_rf_tbl1
where (
  cast(b as VARCHAR) < '2');

alter PUBLICATION testpub5 set table testpub_rf_tbl4 where ( length(g) < 6);

create type rf_bug_status as enum ('new', 'open', 'closed');

create table rf_bug (
  id serial,
  description TEXT,
  status rf_bug_status
);

create PUBLICATION testpub6
for table rf_bug where (status = 'open')
with (publish = 'insert');

drop TABLE "rf_bug";

drop TYPE rf_bug_status;

create PUBLICATION testpub6
for table testpub_rf_tbl1 where (a in (select generate_series(1, 5)));

create PUBLICATION testpub6
for table testpub_rf_tbl1 where (cast('(0,1)' as TID) = ctid);

alter PUBLICATION testpub5 set table testpub_rf_tbl5 where ( a is DOCUMENT);

alter PUBLICATION testpub5 set
table testpub_rf_tbl5
where (
  xmlexists('//foo[text() = ''bar'']' PASSING a));

alter PUBLICATION testpub5 set table testpub_rf_tbl1 where ( nullif(1, 2) = a);

alter PUBLICATION testpub5 set
table testpub_rf_tbl1
where (
  case a when 5 then true else false end);

alter PUBLICATION testpub5 set
table testpub_rf_tbl1
where (
  coalesce(b, 'foo') = 'foo');

alter PUBLICATION testpub5 set
table testpub_rf_tbl1
where (
  greatest(a, 10) > 10);

alter PUBLICATION testpub5 set table testpub_rf_tbl1 where ( a in (2, 4, 6));

alter PUBLICATION testpub5 set
table testpub_rf_tbl1
where (
  array[a] <@ array[2, 4, 6]);

alter PUBLICATION testpub5 set table testpub_rf_tbl1 where ( row(a, 2) is null);

alter PUBLICATION testpub5 drop table testpub_rf_tbl1 where ( e < 27);

set client_min_messages = ERROR;

create PUBLICATION testpub6 for TABLES in SCHEMA testpub_rf_schema2;

alter PUBLICATION testpub6 set
TABLES in SCHEMA testpub_rf_schema2,
table testpub_rf_schema2.testpub_rf_tbl6
where (
  i < 99);

reset client_min_messages;

create PUBLICATION testpub7 for table testpub_rf_tbl6 where (y > 100);

set client_min_messages = ERROR;

create PUBLICATION testpub8 for table testpub_rf_tbl7 where (y > 100);

alter table testpub_rf_tbl7
  alter column y set EXPRESSION
  as (x * testpub_rf_func2());

reset client_min_messages;

drop TABLE "testpub_rf_tbl1";

drop TABLE "testpub_rf_tbl2";

drop TABLE "testpub_rf_tbl3";

drop TABLE "testpub_rf_tbl4";

drop TABLE "testpub_rf_tbl5";

drop TABLE "testpub_rf_schema1"."testpub_rf_tbl5";

drop TABLE "testpub_rf_schema2"."testpub_rf_tbl6";

drop SCHEMA testpub_rf_schema1;

drop SCHEMA testpub_rf_schema2;

drop PUBLICATION testpub5;

drop PUBLICATION testpub6;

drop PUBLICATION testpub8;

drop TABLE "testpub_rf_tbl7";

drop OPERATOR =#> (INT, INT);

drop FUNCTION testpub_rf_func1(INT, INT);

drop FUNCTION testpub_rf_func2();

drop COLLATION "user_collation";

create table rf_tbl_abcd_nopk (
  a INT,
  b INT,
  c INT,
  d INT
);

create table rf_tbl_abcd_pk (
  a INT,
  b INT,
  c INT,
  d INT,
  primary key (a, b)
);

create table rf_tbl_abcd_part_pk (
  a INT primary key,
  b INT
)
partition by range(a);

create table rf_tbl_abcd_part_pk_1 (
  b INT,
  a INT primary key
);

alter table rf_tbl_abcd_part_pk
  ATTACH partition
  rf_tbl_abcd_part_pk_1
  for values from (1) to (10);

set client_min_messages = ERROR;

create PUBLICATION testpub6 for table rf_tbl_abcd_pk where (a > 99);

reset client_min_messages;

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk where ( b > 99);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk where ( c > 99);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk where ( d > 99);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk where ( a > 99);

update rf_tbl_abcd_nopk set a = 1;

alter table rf_tbl_abcd_pk
  REPLICA IDENTITY FULL;

alter table rf_tbl_abcd_nopk
  REPLICA IDENTITY FULL;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk where ( c > 99);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk where ( a > 99);

update rf_tbl_abcd_nopk set a = 1;

alter table rf_tbl_abcd_pk
  REPLICA IDENTITY NOTHING;

alter table rf_tbl_abcd_nopk
  REPLICA IDENTITY NOTHING;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk where ( a > 99);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk where ( c > 99);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk where ( a > 99);

update rf_tbl_abcd_nopk set a = 1;

alter table rf_tbl_abcd_pk
  alter column c set not null;

create unique index "idx_abcd_pk_c" on rf_tbl_abcd_pk using btree (c);

alter table rf_tbl_abcd_pk
  REPLICA IDENTITY
  using index
  idx_abcd_pk_c;

alter table rf_tbl_abcd_nopk
  alter column c set not null;

create unique index "idx_abcd_nopk_c" on rf_tbl_abcd_nopk using btree (c);

alter table rf_tbl_abcd_nopk
  REPLICA IDENTITY
  using index
  idx_abcd_nopk_c;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk where ( a > 99);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk where ( c > 99);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk where ( a > 99);

update rf_tbl_abcd_nopk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk where ( c > 99);

update rf_tbl_abcd_nopk set a = 1;

alter PUBLICATION testpub6 set (publish_via_partition_root = 0);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk where ( a > 99);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk_1 where ( a > 99);

update rf_tbl_abcd_part_pk set a = 1;

alter PUBLICATION testpub6 set (publish_via_partition_root = 1);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk where ( a > 99);

update rf_tbl_abcd_part_pk set a = 1;

alter PUBLICATION testpub6 set (publish_via_partition_root = 0);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk;

alter PUBLICATION testpub6 set (publish_via_partition_root = 0);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk_1 where ( b > 99);

alter PUBLICATION testpub6 set (publish_via_partition_root = 0);

update rf_tbl_abcd_part_pk set a = 1;

alter PUBLICATION testpub6 set (publish_via_partition_root = 1);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk where ( b > 99);

update rf_tbl_abcd_part_pk set a = 1;

drop PUBLICATION testpub6;

drop TABLE "rf_tbl_abcd_pk";

drop TABLE "rf_tbl_abcd_nopk";

drop TABLE "rf_tbl_abcd_part_pk";

set client_min_messages = ERROR;

create table testpub_gencol (
  a INT,
  b INT
  generated always as (a + 1) stored
  not null
);

create unique index "testpub_gencol_idx" on testpub_gencol using btree (b);

alter table testpub_gencol
  REPLICA IDENTITY
  using index
  testpub_gencol_idx;

create PUBLICATION pub_gencol for table testpub_gencol;

update testpub_gencol set a = 100 where a = 1;

alter table testpub_gencol
  REPLICA IDENTITY FULL;

update testpub_gencol set a = 100 where a = 1;

drop PUBLICATION pub_gencol;

create PUBLICATION pub_gencol
for table testpub_gencol
with (publish_generated_columns = stored);

update testpub_gencol set a = 100 where a = 1;

drop PUBLICATION pub_gencol;

drop TABLE "testpub_gencol";

create PUBLICATION pub_gencol for table testpub_gencol;

alter table testpub_gencol
  REPLICA IDENTITY FULL;

update testpub_gencol set a = 100 where a = 1;

drop PUBLICATION pub_gencol;

create PUBLICATION pub_gencol
for table testpub_gencol
with (publish_generated_columns = stored);

update testpub_gencol set a = 100 where a = 1;

drop PUBLICATION pub_gencol;

drop TABLE "testpub_gencol";

reset client_min_messages;

set client_min_messages = ERROR;

create PUBLICATION testpub_dups
for table testpub_tbl1 (a),
table testpub_tbl1
with (publish = 'insert');

create PUBLICATION testpub_dups
for table testpub_tbl1,
table testpub_tbl1 (a)
with (publish = 'insert');

reset client_min_messages;

set client_min_messages = ERROR;

create PUBLICATION testpub_fortable for table testpub_tbl1;

create PUBLICATION testpub_fortable_insert with (publish = 'insert');

reset client_min_messages;

alter PUBLICATION testpub_fortable add table testpub_tbl5 (a, x);

alter PUBLICATION testpub_fortable add table testpub_tbl5 (b, c);

update testpub_tbl5 set a = 1;

alter PUBLICATION testpub_fortable drop table testpub_tbl5;

alter PUBLICATION testpub_fortable add table testpub_tbl5 (a, ctid);

alter PUBLICATION testpub_fortable set table testpub_tbl1 (id, ctid);

alter PUBLICATION testpub_fortable add table testpub_tbl5 (a, a);

alter PUBLICATION testpub_fortable set table testpub_tbl5 (a, a);

alter PUBLICATION testpub_fortable add table testpub_tbl5 (a, c);

alter table testpub_tbl5
  drop column c;

alter PUBLICATION testpub_fortable_insert add table testpub_tbl5 (b, c);

create unique index "testpub_tbl5_b_key" on testpub_tbl5 using btree (b, c);

alter table testpub_tbl5
  alter column b set not null,
  alter column c set not null;

alter table testpub_tbl5
  REPLICA IDENTITY
  using index
  testpub_tbl5_b_key;

update testpub_tbl5 set a = 1;

alter PUBLICATION testpub_fortable drop table testpub_tbl5;

alter PUBLICATION testpub_fortable add table testpub_tbl5 (a, d);

alter PUBLICATION testpub_fortable drop table testpub_tbl5;

alter PUBLICATION testpub_fortable add table testpub_tbl5 (a, e);

alter table testpub_tbl5
  REPLICA IDENTITY
  using index
  testpub_tbl5_b_key;

alter PUBLICATION testpub_fortable add table testpub_tbl5 (a, c);

update testpub_tbl5 set a = 1;

set client_min_messages = ERROR;

create PUBLICATION testpub_table_ins with (publish = 'insert, truncate');

reset client_min_messages;

alter PUBLICATION testpub_table_ins add table testpub_tbl5 (a);

create table testpub_tbl5d (a INT primary key deferrable);

alter PUBLICATION testpub_fortable add table testpub_tbl5d;

update testpub_tbl5d set a = 1;

alter table testpub_tbl5d
  REPLICA IDENTITY FULL;

update testpub_tbl5d set a = 1;

drop TABLE "testpub_tbl5d";

create table testpub_tbl6 (
  a INT,
  b TEXT,
  c TEXT
);

alter table testpub_tbl6
  REPLICA IDENTITY FULL;

alter PUBLICATION testpub_fortable add table testpub_tbl6 (a, b, c);

update testpub_tbl6 set a = 1;

alter PUBLICATION testpub_fortable drop table testpub_tbl6;

alter PUBLICATION testpub_fortable add table testpub_tbl6;

update testpub_tbl6 set a = 1;

create table testpub_tbl7 (
  a INT primary key,
  b TEXT,
  c TEXT
);

alter PUBLICATION testpub_fortable add table testpub_tbl7 (a, b);

alter PUBLICATION testpub_fortable set table testpub_tbl7 (a, b);

alter PUBLICATION testpub_fortable set table testpub_tbl7 (a, c);

create table testpub_tbl8 (
  a INT,
  b TEXT,
  c TEXT
)
partition by HASH(a);

create table testpub_tbl8_0
partition of testpub_tbl8
for values with (MODULUS 2, REMAINDER 0);

alter table testpub_tbl8_0
  add primary key (a);

alter table testpub_tbl8_0
  REPLICA IDENTITY
  using index
  testpub_tbl8_0_pkey;

create table testpub_tbl8_1
partition of testpub_tbl8
for values with (MODULUS 2, REMAINDER 1);

alter table testpub_tbl8_1
  add primary key (b);

alter table testpub_tbl8_1
  REPLICA IDENTITY
  using index
  testpub_tbl8_1_pkey;

set client_min_messages = ERROR;

create PUBLICATION testpub_col_list
for table testpub_tbl8 (a,
b)
with (publish_via_partition_root = 'true');

reset client_min_messages;

alter PUBLICATION testpub_col_list drop table testpub_tbl8;

alter PUBLICATION testpub_col_list add table testpub_tbl8 (a, b);

update testpub_tbl8 set a = 1;

alter PUBLICATION testpub_col_list drop table testpub_tbl8;

alter PUBLICATION testpub_col_list add table testpub_tbl8 (a, c);

update testpub_tbl8 set a = 1;

alter PUBLICATION testpub_col_list drop table testpub_tbl8;

alter table testpub_tbl8_1
  REPLICA IDENTITY FULL;

alter PUBLICATION testpub_col_list add table testpub_tbl8 (a, c);

update testpub_tbl8 set a = 1;

alter PUBLICATION testpub_col_list drop table testpub_tbl8;

alter table testpub_tbl8_1
  REPLICA IDENTITY
  using index
  testpub_tbl8_1_pkey;

alter PUBLICATION testpub_col_list add table testpub_tbl8 (a, b);

alter table testpub_tbl8_1
  REPLICA IDENTITY FULL;

update testpub_tbl8 set a = 1;

alter table testpub_tbl8_1
  drop constraint testpub_tbl8_1_pkey;

alter table testpub_tbl8_1
  add primary key (c);

alter table testpub_tbl8_1
  REPLICA IDENTITY
  using index
  testpub_tbl8_1_pkey;

update testpub_tbl8 set a = 1;

drop TABLE "testpub_tbl8";

create table testpub_tbl8 (
  a INT,
  b TEXT,
  c TEXT
)
partition by HASH(a);

alter PUBLICATION testpub_col_list add table testpub_tbl8 (a, b);

create table testpub_tbl8_0 (
  a INT,
  b TEXT,
  c TEXT
);

alter table testpub_tbl8_0
  add primary key (a);

alter table testpub_tbl8_0
  REPLICA IDENTITY
  using index
  testpub_tbl8_0_pkey;

create table testpub_tbl8_1 (
  a INT,
  b TEXT,
  c TEXT
);

alter table testpub_tbl8_1
  add primary key (c);

alter table testpub_tbl8_1
  REPLICA IDENTITY
  using index
  testpub_tbl8_1_pkey;

update testpub_tbl8 set a = 1;

alter table testpub_tbl8_0
  REPLICA IDENTITY FULL;

update testpub_tbl8 set a = 1;

set client_min_messages = ERROR;

create PUBLICATION testpub_tbl9
for TABLES in SCHEMA public,
table public.testpub_tbl7 (a);

create PUBLICATION testpub_tbl9 for TABLES in SCHEMA public;

alter PUBLICATION testpub_tbl9 add table public.testpub_tbl7 (a);

alter PUBLICATION testpub_tbl9 set table public.testpub_tbl7 (a);

alter PUBLICATION testpub_tbl9 add TABLES in SCHEMA public;

alter PUBLICATION testpub_tbl9 set
TABLES in SCHEMA public,
table public.testpub_tbl7 (a);

alter PUBLICATION testpub_tbl9 drop table public.testpub_tbl7;

alter PUBLICATION testpub_tbl9 add
TABLES in SCHEMA public,
table public.testpub_tbl7 (a);

reset client_min_messages;

drop TABLE
  "testpub_tbl5",
  "testpub_tbl6",
  "testpub_tbl7",
  "testpub_tbl8",
  "testpub_tbl8_1";

drop PUBLICATION
  testpub_table_ins,
  testpub_fortable,
  testpub_fortable_insert,
  testpub_col_list,
  testpub_tbl9;

set client_min_messages = ERROR;

create PUBLICATION testpub_both_filters;

reset client_min_messages;

create table testpub_tbl_both_filters (
  a INT,
  b INT,
  c INT,
  primary key (a, c)
);

alter table testpub_tbl_both_filters
  REPLICA IDENTITY
  using index
  testpub_tbl_both_filters_pkey;

alter PUBLICATION testpub_both_filters add
table testpub_tbl_both_filters (a,
c)
where (
  c <> 1);

drop TABLE "testpub_tbl_both_filters";

drop PUBLICATION testpub_both_filters;

create table rf_tbl_abcd_nopk (
  a INT,
  b INT,
  c INT,
  d INT
);

create table rf_tbl_abcd_pk (
  a INT,
  b INT,
  c INT,
  d INT,
  primary key (a, b)
);

create table rf_tbl_abcd_part_pk (
  a INT primary key,
  b INT
)
partition by range(a);

create table rf_tbl_abcd_part_pk_1 (
  b INT,
  a INT primary key
);

alter table rf_tbl_abcd_part_pk
  ATTACH partition
  rf_tbl_abcd_part_pk_1
  for values from (1) to (10);

set client_min_messages = ERROR;

create PUBLICATION testpub6 for table rf_tbl_abcd_pk (a, b);

reset client_min_messages;

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk (a, b, c);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk (a);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk (b);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk (a);

update rf_tbl_abcd_nopk set a = 1;

alter table rf_tbl_abcd_pk
  REPLICA IDENTITY FULL;

alter table rf_tbl_abcd_nopk
  REPLICA IDENTITY FULL;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk (c);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk (a, b, c, d);

update rf_tbl_abcd_nopk set a = 1;

alter table rf_tbl_abcd_pk
  REPLICA IDENTITY NOTHING;

alter table rf_tbl_abcd_nopk
  REPLICA IDENTITY NOTHING;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk (a);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk (a, b, c, d);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk (d);

update rf_tbl_abcd_nopk set a = 1;

alter table rf_tbl_abcd_pk
  alter column c set not null;

create unique index "idx_abcd_pk_c" on rf_tbl_abcd_pk using btree (c);

alter table rf_tbl_abcd_pk
  REPLICA IDENTITY
  using index
  idx_abcd_pk_c;

alter table rf_tbl_abcd_nopk
  alter column c set not null;

create unique index "idx_abcd_nopk_c" on rf_tbl_abcd_nopk using btree (c);

alter table rf_tbl_abcd_nopk
  REPLICA IDENTITY
  using index
  idx_abcd_nopk_c;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk (a);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_pk (c);

update rf_tbl_abcd_pk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk (a);

update rf_tbl_abcd_nopk set a = 1;

alter PUBLICATION testpub6 set table rf_tbl_abcd_nopk (c);

update rf_tbl_abcd_nopk set a = 1;

alter PUBLICATION testpub6 set (publish_via_partition_root = 0);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk (a);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk_1 (a);

update rf_tbl_abcd_part_pk set a = 1;

alter PUBLICATION testpub6 set (publish_via_partition_root = 1);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk (a);

update rf_tbl_abcd_part_pk set a = 1;

alter PUBLICATION testpub6 set (publish_via_partition_root = 0);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk;

alter PUBLICATION testpub6 set (publish_via_partition_root = 0);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk_1 (b);

alter PUBLICATION testpub6 set (publish_via_partition_root = 0);

update rf_tbl_abcd_part_pk set a = 1;

alter PUBLICATION testpub6 set (publish_via_partition_root = 1);

alter PUBLICATION testpub6 set table rf_tbl_abcd_part_pk (b);

update rf_tbl_abcd_part_pk set a = 1;

drop PUBLICATION testpub6;

drop TABLE "rf_tbl_abcd_pk";

drop TABLE "rf_tbl_abcd_nopk";

drop TABLE "rf_tbl_abcd_part_pk";

set client_min_messages = ERROR;

create table testpub_tbl4 (a INT);

insert into testpub_tbl4 values (1);

update testpub_tbl4 set a = 2;

create PUBLICATION testpub_foralltables for all TABLES;

reset client_min_messages;

update testpub_tbl4 set a = 3;

drop PUBLICATION testpub_foralltables;

update testpub_tbl4 set a = 3;

drop TABLE "testpub_tbl4";

create PUBLICATION testpub_fortbl for table testpub_view;

create temporary table testpub_temptbl (a INT);

create PUBLICATION testpub_fortemptbl for table testpub_temptbl;

drop TABLE "testpub_temptbl";

create unlogged table testpub_unloggedtbl (a INT);

create PUBLICATION testpub_forunloggedtbl for table testpub_unloggedtbl;

drop TABLE "testpub_unloggedtbl";

create PUBLICATION testpub_forsystemtbl for table pg_publication;

set client_min_messages = ERROR;

create PUBLICATION testpub_fortbl
for table testpub_tbl1,
table pub_test.testpub_nopk;

reset client_min_messages;

alter PUBLICATION testpub_fortbl add table testpub_tbl1;

create PUBLICATION testpub_fortbl for table testpub_tbl1;

alter PUBLICATION testpub_default add table testpub_view;

alter PUBLICATION testpub_default add table testpub_tbl1;

alter PUBLICATION testpub_default set table testpub_tbl1;

alter PUBLICATION testpub_default add table pub_test.testpub_nopk;

alter PUBLICATION testpub_ins_trunct add
table pub_test.testpub_nopk,
table testpub_tbl1;

alter PUBLICATION testpub_default drop
table testpub_tbl1,
table pub_test.testpub_nopk;

alter PUBLICATION testpub_default drop table pub_test.testpub_nopk;

create table pub_test.testpub_addpk (
  id INT not null,
  data INT
);

alter PUBLICATION testpub_default add table pub_test.testpub_addpk;

insert into pub_test.testpub_addpk values (1, 11);

create unique
index "testpub_addpk_id_idx"
on pub_test.testpub_addpk
using btree
(
  id
);

update pub_test.testpub_addpk set id = 2;

alter table pub_test.testpub_addpk
  add primary key using index "testpub_addpk_id_idx";

update pub_test.testpub_addpk set id = 2;

drop TABLE "pub_test"."testpub_addpk";

set role to regress_publication_user2;

create PUBLICATION testpub2;

set role to regress_publication_user;

grant CREATE on database regression to regress_publication_user2;

set role to regress_publication_user2;

set client_min_messages = ERROR;

create PUBLICATION testpub2;

create PUBLICATION testpub3 for TABLES in SCHEMA pub_test;

create PUBLICATION testpub3;

reset client_min_messages;

alter PUBLICATION testpub2 add table testpub_tbl1;

alter PUBLICATION testpub3 add TABLES in SCHEMA pub_test;

set role to regress_publication_user;

grant REGRESS_PUBLICATION_USER to regress_publication_user2;

set role to regress_publication_user2;

alter PUBLICATION testpub2 add table testpub_tbl1;

drop PUBLICATION testpub2;

drop PUBLICATION testpub3;

set role to regress_publication_user;

create role regress_publication_user3;

grant REGRESS_PUBLICATION_USER2 to regress_publication_user3;

set client_min_messages = ERROR;

create PUBLICATION testpub4 for TABLES in SCHEMA pub_test;

reset client_min_messages;

alter publication testpub4 owner to regress_publication_user3;

set role to regress_publication_user3;

alter publication testpub4 owner to regress_publication_user2;

alter publication testpub4 owner to regress_publication_user;

set role to regress_publication_user;

drop PUBLICATION testpub4;

drop role regress_publication_user3;

revoke CREATE on database regression from regress_publication_user2;

drop TABLE "testpub_parted";

drop TABLE "testpub_tbl1";

set role to regress_publication_user_dummy;

alter publication testpub_default rename to testpub_dummy;

reset role;

alter publication testpub_default rename to testpub_foo;

alter publication testpub_foo rename to testpub_default;

alter publication testpub_default owner to regress_publication_user2;

create schema "pub_test1";

create schema "pub_test2";

create schema "pub_test3";

create schema "CURRENT_SCHEMA";

create table pub_test1.tbl (
  id INT,
  data TEXT
);

create table pub_test1.tbl1 (
  id serial primary key,
  data TEXT
);

create table pub_test2.tbl1 (
  id serial primary key,
  data TEXT
);

create table "CURRENT_SCHEMA"."CURRENT_SCHEMA" (id INT);

set client_min_messages = ERROR;

create PUBLICATION testpub1_forschema for TABLES in SCHEMA pub_test1;

create PUBLICATION testpub2_forschema
for TABLES in SCHEMA pub_test1,
TABLES in SCHEMA pub_test2,
TABLES in SCHEMA pub_test3;

create PUBLICATION testpub3_forschema for TABLES in SCHEMA CURRENT_SCHEMA;

create PUBLICATION testpub4_forschema for TABLES in SCHEMA CURRENT_SCHEMA;

create PUBLICATION testpub5_forschema
for TABLES in SCHEMA CURRENT_SCHEMA,
TABLES in SCHEMA CURRENT_SCHEMA;

create PUBLICATION testpub6_forschema
for TABLES in SCHEMA CURRENT_SCHEMA,
TABLES in SCHEMA CURRENT_SCHEMA;

create PUBLICATION testpub_fortable for table "CURRENT_SCHEMA"."CURRENT_SCHEMA";

reset client_min_messages;

set search_path to '';

create PUBLICATION testpub_forschema for TABLES in SCHEMA CURRENT_SCHEMA;

reset search_path;

create PUBLICATION testpub_forschema for TABLES in SCHEMA non_existent_schema;

create PUBLICATION testpub_forschema for TABLES in SCHEMA pg_catalog;

create PUBLICATION testpub1_forschema1 for TABLES in SCHEMA testpub_view;

drop SCHEMA pub_test3;

alter schema pub_test1 rename to pub_test1_renamed;

alter schema pub_test1_renamed rename to pub_test1;

alter PUBLICATION testpub1_forschema add TABLES in SCHEMA pub_test2;

alter PUBLICATION testpub1_forschema add TABLES in SCHEMA non_existent_schema;

alter PUBLICATION testpub1_forschema add TABLES in SCHEMA pub_test1;

alter PUBLICATION testpub1_forschema drop TABLES in SCHEMA pub_test2;

alter PUBLICATION testpub1_forschema drop TABLES in SCHEMA pub_test2;

alter PUBLICATION testpub1_forschema drop TABLES in SCHEMA non_existent_schema;

alter PUBLICATION testpub1_forschema drop TABLES in SCHEMA pub_test1;

alter PUBLICATION testpub1_forschema set
TABLES in SCHEMA pub_test1,
TABLES in SCHEMA pub_test2;

alter PUBLICATION testpub1_forschema set TABLES in SCHEMA non_existent_schema;

alter PUBLICATION testpub1_forschema set
TABLES in SCHEMA pub_test1,
TABLES in SCHEMA pub_test1;

alter PUBLICATION testpub2_forschema drop TABLES in SCHEMA pub_test1;

drop PUBLICATION
  testpub3_forschema,
  testpub4_forschema,
  testpub5_forschema,
  testpub6_forschema,
  testpub_fortable;

drop SCHEMA "CURRENT_SCHEMA" cascade;

insert into pub_test1.tbl values (1, 'test');

update pub_test1.tbl set id = 2;

alter PUBLICATION testpub1_forschema drop TABLES in SCHEMA pub_test1;

update pub_test1.tbl set id = 2;

alter PUBLICATION testpub1_forschema set TABLES in SCHEMA pub_test1;

update pub_test1.tbl set id = 2;

create schema "pub_testpart1";

create schema "pub_testpart2";

create table pub_testpart1.parent1 (a INT)
partition by LIST(a);

create table pub_testpart2.child_parent1
partition of pub_testpart1.parent1
for values in (1);

insert into pub_testpart2.child_parent1 values (1);

update pub_testpart2.child_parent1 set a = 1;

set client_min_messages = ERROR;

create PUBLICATION testpubpart_forschema for TABLES in SCHEMA pub_testpart1;

reset client_min_messages;

update pub_testpart1.parent1 set a = 1;

update pub_testpart2.child_parent1 set a = 1;

drop PUBLICATION testpubpart_forschema;

create table pub_testpart2.parent2 (a INT)
partition by LIST(a);

create table pub_testpart1.child_parent2
partition of pub_testpart2.parent2
for values in (1);

insert into pub_testpart1.child_parent2 values (1);

update pub_testpart1.child_parent2 set a = 1;

set client_min_messages = ERROR;

create PUBLICATION testpubpart_forschema for TABLES in SCHEMA pub_testpart2;

reset client_min_messages;

update pub_testpart2.child_parent1 set a = 1;

update pub_testpart2.parent2 set a = 1;

update pub_testpart1.child_parent2 set a = 1;

set client_min_messages = ERROR;

create PUBLICATION testpub3_forschema;

reset client_min_messages;

alter PUBLICATION testpub3_forschema set TABLES in SCHEMA pub_test1;

set client_min_messages = ERROR;

create PUBLICATION testpub_forschema_fortable
for TABLES in SCHEMA pub_test1,
table pub_test2.tbl1;

create PUBLICATION testpub_fortable_forschema
for table pub_test2.tbl1,
TABLES in SCHEMA pub_test1;

reset client_min_messages;

drop VIEW "testpub_view";

drop PUBLICATION testpub_default;

drop PUBLICATION testpub_ins_trunct;

drop PUBLICATION testpub_fortbl;

drop PUBLICATION testpub1_forschema;

drop PUBLICATION testpub2_forschema;

drop PUBLICATION testpub3_forschema;

drop PUBLICATION testpub_forschema_fortable;

drop PUBLICATION testpub_fortable_forschema;

drop PUBLICATION testpubpart_forschema;

drop SCHEMA pub_test cascade;

drop SCHEMA pub_test1 cascade;

drop SCHEMA pub_test2 cascade;

drop SCHEMA pub_testpart1 cascade;

drop SCHEMA pub_testpart2 cascade;

set client_min_messages = ERROR;

create schema "sch1";

create schema "sch2";

create table sch1.tbl1 (a INT)
partition by range(a);

create table sch2.tbl1_part1 partition of sch1.tbl1 for values from (1) to (10);

create PUBLICATION pub
for TABLES in SCHEMA sch2
with (publish_via_partition_root = 1);

select * from pg_publication_tables;

drop PUBLICATION pub;

create PUBLICATION pub
for table sch2.tbl1_part1
with (publish_via_partition_root = 1);

select * from pg_publication_tables;

alter PUBLICATION pub add table sch1.tbl1;

select * from pg_publication_tables;

drop PUBLICATION pub;

create PUBLICATION pub
for TABLES in SCHEMA sch2
with (publish_via_partition_root = 0);

select * from pg_publication_tables;

drop PUBLICATION pub;

create PUBLICATION pub
for table sch2.tbl1_part1
with (publish_via_partition_root = 0);

select * from pg_publication_tables;

alter PUBLICATION pub add table sch1.tbl1;

select * from pg_publication_tables;

drop PUBLICATION pub;

drop TABLE "sch2"."tbl1_part1";

drop TABLE "sch1"."tbl1";

create table sch1.tbl1 (a INT)
partition by range(a);

create table sch1.tbl1_part1 partition of sch1.tbl1 for values from (1) to (10);

create table sch1.tbl1_part2
partition of sch1.tbl1
for values from (10) to (20);

create table sch1.tbl1_part3 (a INT)
partition by range(a);

alter table sch1.tbl1
  ATTACH partition
  sch1.tbl1_part3
  for values from (20) to (30);

create PUBLICATION pub
for TABLES in SCHEMA sch1
with (publish_via_partition_root = 1);

select * from pg_publication_tables;

reset client_min_messages;

drop PUBLICATION pub;

drop TABLE "sch1"."tbl1";

drop SCHEMA sch1 cascade;

drop SCHEMA sch2 cascade;

set client_min_messages = ERROR;

create PUBLICATION pub1 for all TABLES
with (publish_generated_columns = stored);

create PUBLICATION pub2 for all TABLES
with (publish_generated_columns = 'none');

drop PUBLICATION pub1;

drop PUBLICATION pub2;

create table gencols (
  a INT,
  gen1 INT
  generated always as (a * 2) stored
);

create PUBLICATION pub1
for table gencols (a,
gen1)
with (publish_generated_columns = 'none');

create PUBLICATION pub2
for table gencols (a,
gen1)
with (publish_generated_columns = stored);

alter PUBLICATION pub2 set (publish_generated_columns = 'none');

alter PUBLICATION pub2 set table gencols (a);

alter PUBLICATION pub2 set table gencols (a, gen1);

drop PUBLICATION pub1;

drop PUBLICATION pub2;

drop TABLE "gencols";

reset client_min_messages;

create table testpub_insert_onconfl_no_ri (
  a INT unique,
  b INT
);

create table testpub_insert_onconfl_parted (
  a INT unique,
  b INT
)
partition by range(a);

create table testpub_insert_onconfl_part_no_ri
partition of testpub_insert_onconfl_parted
for values from (1) to (10);

set client_min_messages = ERROR;

create PUBLICATION pub1 for all TABLES;

reset client_min_messages;

insert into testpub_insert_onconfl_no_ri
values (1, 1)
on conflict (a) do update set b = 2;

insert into testpub_insert_onconfl_no_ri values (1, 1) on conflict do nothing;

insert into testpub_insert_onconfl_parted
values (1, 1)
on conflict (a) do update set b = 2;

insert into testpub_insert_onconfl_parted values (1, 1) on conflict do nothing;

drop PUBLICATION pub1;

drop TABLE "testpub_insert_onconfl_no_ri";

drop TABLE "testpub_insert_onconfl_parted";

create table testpub_merge_no_ri (
  a INT,
  b INT
);

create table testpub_merge_pk (
  a INT primary key,
  b INT
);

set client_min_messages = ERROR;

create PUBLICATION pub1 for all TABLES;

reset client_min_messages;

drop PUBLICATION pub1;

drop TABLE "testpub_merge_no_ri";

drop TABLE "testpub_merge_pk";

reset session_authorization;

drop role regress_publication_user, regress_publication_user2;

drop role regress_publication_user_dummy;

create schema "pubme";

create table t0 (
  c INT,
  d INT
);

create table t1 (c INT);

create schema "pubme2";

create table t0 (
  c INT,
  d INT
);

set client_min_messages = ERROR;

create PUBLICATION dump_pub_qual_1ct
for table only pubme.t0 (c,
d) where (c > 0);

create PUBLICATION dump_pub_qual_2ct
for table only pubme.t0 (c) where (c > 0),
table only pubme.t1 (c);

create PUBLICATION dump_pub_nsp_1ct for TABLES in SCHEMA pubme;

create PUBLICATION dump_pub_nsp_2ct
for TABLES in SCHEMA pubme,
TABLES in SCHEMA pubme2;

create PUBLICATION dump_pub_all
for table only pubme.t0,
table only pubme.t1 where (c < 0),
TABLES in SCHEMA pubme,
TABLES in SCHEMA pubme2
with (publish_via_partition_root = 'true');

reset client_min_messages;
