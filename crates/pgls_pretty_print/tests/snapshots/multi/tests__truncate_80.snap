---
source: crates/pgls_pretty_print/tests/tests.rs
input_file: crates/pgls_pretty_print/tests/data/multi/truncate.sql
---
create table truncate_a (col1 int primary key);

insert into truncate_a values (1);

insert into truncate_a values (2);

select * from truncate_a;

begin;

truncate truncate_a;

rollback;

select * from truncate_a;

begin;

truncate truncate_a;

commit;

select * from truncate_a;

create table trunc_b (a int references truncate_a);

create table trunc_c (a serial primary key);

create table trunc_d (a int references trunc_c);

create table trunc_e (
  a int references truncate_a,
  b int references trunc_c
);

truncate truncate_a;

truncate truncate_a, trunc_b;

truncate truncate_a, trunc_b, trunc_e;

truncate truncate_a, trunc_e;

truncate trunc_c;

truncate trunc_c, trunc_d;

truncate trunc_c, trunc_d, trunc_e;

truncate trunc_c, trunc_d, trunc_e, truncate_a;

truncate trunc_c, trunc_d, trunc_e, truncate_a, trunc_b;

truncate truncate_a;

truncate truncate_a cascade;

alter table truncate_a
  add foreign key (col1) references trunc_c;

insert into trunc_c values (1);

insert into truncate_a values (1);

insert into trunc_b values (1);

insert into trunc_d values (1);

insert into trunc_e values (1, 1);

truncate trunc_c;

truncate trunc_c, truncate_a;

truncate trunc_c, truncate_a, trunc_d;

truncate trunc_c, truncate_a, trunc_d, trunc_e;

truncate trunc_c, truncate_a, trunc_d, trunc_e, trunc_b;

select * from truncate_a
union all
select * from trunc_c
union all
select * from trunc_b
union all
select * from trunc_d;

select * from trunc_e;

insert into trunc_c values (1);

insert into truncate_a values (1);

insert into trunc_b values (1);

insert into trunc_d values (1);

insert into trunc_e values (1, 1);

truncate trunc_c cascade;

select * from truncate_a
union all
select * from trunc_c
union all
select * from trunc_b
union all
select * from trunc_d;

select * from trunc_e;

drop table truncate_a, trunc_c, trunc_b, trunc_d, trunc_e cascade;

create table trunc_f (col1 int primary key);

insert into trunc_f values (1);

insert into trunc_f values (2);

create table trunc_fa (col2a text)
inherits (trunc_f);

insert into trunc_fa values (3, 'three');

create table trunc_fb (col2b int)
inherits (trunc_f);

insert into trunc_fb values (4, 444);

create table trunc_faa (col3 text)
inherits (trunc_fa);

insert into trunc_faa values (5, 'five', 'FIVE');

begin;

select * from trunc_f;

truncate trunc_f;

select * from trunc_f;

rollback;

begin;

select * from trunc_f;

truncate only trunc_f;

select * from trunc_f;

rollback;

begin;

select * from trunc_f;

select * from trunc_fa;

select * from trunc_faa;

truncate only trunc_fb, only trunc_fa;

select * from trunc_f;

select * from trunc_fa;

select * from trunc_faa;

rollback;

begin;

select * from trunc_f;

select * from trunc_fa;

select * from trunc_faa;

truncate only trunc_fb, trunc_fa;

select * from trunc_f;

select * from trunc_fa;

select * from trunc_faa;

rollback;

drop table trunc_f cascade;

create table trunc_trigger_test (
  f1 int,
  f2 text,
  f3 text
);

create table trunc_trigger_log (
  tgop text,
  tglevel text,
  tgwhen text,
  tgargv text,
  tgtable name,
  rowcount bigint
);

create function trunctrigger()
returns trigger
as $function$
declare c bigint;
begin
    execute 'select count(*) from ' || quote_ident(tg_table_name) into c;
    insert into trunc_trigger_log values
      (TG_OP, TG_LEVEL, TG_WHEN, TG_ARGV[0], tg_table_name, c);
    return null;
end;
$function$
language plpgsql;

insert into trunc_trigger_test values (1, 'foo', 'bar'), (2, 'baz', 'quux');

create trigger t
before truncate
on trunc_trigger_test
for each statement
execute function trunctrigger("before trigger truncate");

select COUNT(*) as "Row count in test table" from trunc_trigger_test;

select * from trunc_trigger_log;

truncate trunc_trigger_test;

select COUNT(*) as "Row count in test table" from trunc_trigger_test;

select * from trunc_trigger_log;

drop trigger t on trunc_trigger_test;

truncate trunc_trigger_log;

insert into trunc_trigger_test values (1, 'foo', 'bar'), (2, 'baz', 'quux');

create trigger tt
after truncate
on trunc_trigger_test
for each statement
execute function trunctrigger("after trigger truncate");

select COUNT(*) as "Row count in test table" from trunc_trigger_test;

select * from trunc_trigger_log;

truncate trunc_trigger_test;

select COUNT(*) as "Row count in test table" from trunc_trigger_test;

select * from trunc_trigger_log;

drop table trunc_trigger_test;

drop table trunc_trigger_log;

drop function trunctrigger();

create sequence truncate_a_id1 start with 33;

create table truncate_a (
  id serial,
  id1 int
  default nextval('truncate_a_id1')
);

alter sequence truncate_a_id1 owned by truncate_a.id1;

insert into truncate_a default values;

insert into truncate_a default values;

select * from truncate_a;

truncate truncate_a;

insert into truncate_a default values;

insert into truncate_a default values;

select * from truncate_a;

truncate truncate_a restart identity;

insert into truncate_a default values;

insert into truncate_a default values;

select * from truncate_a;

create table truncate_b (id int generated always as identity (start with 44));

insert into truncate_b default values;

insert into truncate_b default values;

select * from truncate_b;

truncate truncate_b;

insert into truncate_b default values;

insert into truncate_b default values;

select * from truncate_b;

truncate truncate_b restart identity;

insert into truncate_b default values;

insert into truncate_b default values;

select * from truncate_b;

begin;

truncate truncate_a restart identity;

insert into truncate_a default values;

select * from truncate_a;

rollback;

insert into truncate_a default values;

insert into truncate_a default values;

select * from truncate_a;

drop table truncate_a;

select nextval('truncate_a_id1');

create table truncparted (
  a int,
  b char(1)
)
partition by LIST(a);

truncate only truncparted;

create table truncparted1 partition of truncparted for values in (1);

insert into truncparted values (1, 'a');

truncate only truncparted;

truncate truncparted;

drop table truncparted;

create function tp_ins_data()
returns void
language plpgsql
as $function$
BEGIN
	INSERT INTO truncprim VALUES (1), (100), (150);
	INSERT INTO truncpart VALUES (1), (100), (150);
  END
$function$;

create function
tp_chk_data(
  out pktb regclass,
  out pkval int,
  out fktb regclass,
  out fkval int
)
returns setof record
language plpgsql
as $function$
BEGIN
    RETURN QUERY SELECT
      pk.tableoid::regclass, pk.a, fk.tableoid::regclass, fk.a
    FROM truncprim pk FULL JOIN truncpart fk USING (a)
    ORDER BY 2, 4;
  END
$function$;

create table truncprim (a int primary key);

create table truncpart (a int references truncprim)
partition by range(a);

create table truncpart_1 partition of truncpart for values from (0) to (100);

create table truncpart_2
partition of truncpart
for values from (100) to (200)
partition by range(a);

create table truncpart_2_1
partition of truncpart_2
for values from (100) to (150);

create table truncpart_2_d partition of truncpart_2 default;

truncate truncprim;

select tp_ins_data();

truncate truncprim, truncpart;

select * from tp_chk_data();

select tp_ins_data();

truncate truncprim cascade;

select * from tp_chk_data();

select tp_ins_data();

truncate truncpart;

select * from tp_chk_data();

drop table truncprim, truncpart;

drop function tp_ins_data(), tp_chk_data();

create table trunc_a (a int primary key)
partition by range(a);

create table trunc_a1 partition of trunc_a for values from (0) to (10);

create table trunc_a2
partition of trunc_a
for values from (10) to (20)
partition by range(a);

create table trunc_a21 partition of trunc_a2 for values from (10) to (12);

create table trunc_a22 partition of trunc_a2 for values from (12) to (16);

create table trunc_a2d partition of trunc_a2 default;

create table trunc_a3 partition of trunc_a for values from (20) to (30);

insert into trunc_a values (0), (5), (10), (15), (20), (25);

create table ref_b (
  b int primary key,
  a int
  references trunc_a (a) on DELETE cascade
);

insert into ref_b values (10, 0), (50, 5), (100, 10), (150, 15);

truncate trunc_a1 cascade;

select a from ref_b;

drop table ref_b;

create table ref_c (
  c int primary key,
  a int
  references trunc_a (a) on DELETE cascade
)
partition by range(c);

create table ref_c1 partition of ref_c for values from (100) to (200);

create table ref_c2 partition of ref_c for values from (200) to (300);

insert into ref_c values (100, 10), (150, 15), (200, 20), (250, 25);

truncate trunc_a21 cascade;

select a as "from table ref_c" from ref_c;

select a as "from table trunc_a" from trunc_a order by a;

drop table trunc_a, ref_c;
